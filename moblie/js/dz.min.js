var dzClass = function(){ var basedz = function(){ BaseInitClass.baseInit(); }; var uploadpicDz = function(){ getuptoken(); function getuptoken(){ AjaxFunUtils.ajaxInit({ "url":"/qiniu/uptoken.html", "params":{bucket:"yinhua"}, "callback":function (res) { if(res.status == 1){ uploaderQiNiu({ token:res.data.token, domain:res.data.domain, bucket:res.data.bucket }); footerMenu(res.data.domain); } } }); }; function dragAndResiza(){ var img_w = $("#printableImg").width(); var img_h = $("#printableImg").height(); var aspectRatio = img_w/img_h; var img_left = $("#printableImgBox").position().left; var img_left = $("#printableImgBox").position().top; $( "#printableImgBox" ).resizable({ containment:'parent', aspectRatio:aspectRatio, alsoResize: '#printableImg', start:function(){ $("#printableArea").addClass("printableArea-over"); }, stop:function(){ $("#printableArea").removeClass("printableArea-over"); } }); $( "#printableImgBox" ).draggable({ containment:'parent' , start:function(){ $("#printableArea").addClass("printableArea-over"); }, stop: function(event, ui) { $("#printableArea").removeClass("printableArea-over"); var printableArea_w = $("#printableArea").width(); var printableArea_h = $("#printableArea").height(); var printableImgBox_l = $("#printableImgBox").position().left; var printableImgBox_t = $("#printableImgBox").position().top; var printableImgBox_w = $("#printableImgBox").width(); var printableImgBox_h = $("#printableImgBox").height(); var l_flag = printableArea_w - printableImgBox_w - printableImgBox_l; var maxtop = printableArea_h - printableImgBox_h; if(l_flag <=0){ $("#printableImgBox").css({"left":printableArea_w - printableImgBox_w}); } if(printableImgBox_t > maxtop){ $("#printableImgBox").css({"top":maxtop}); } img_left = $("#printableImgBox").position().left; img_top = $("#printableImgBox").position().top; $(".printableImgLeft").val(img_left); $(".printableImgTop").val(img_top); } }); }; function viewImg(options){ var settings = { key:'', imgUrl:'' }; if(options){ $.extend(settings,options); } var ImgObj = new Image(); var newimgUrl = settings.imgUrl+'?imageMogr2/auto-orient'; ImgObj.src = newimgUrl; console.log(settings.imgUrl); ImgObj.onload = function() { var printableArea_w = $("#printableArea").width(); var printableArea_h = $("#printableArea").height(); var imgWidth = ImgObj.width; var imgHeight = ImgObj.height; var imgBili = imgWidth/imgHeight; console.log("imgWidth:" + imgWidth); console.log("imgHeight:" + imgHeight); if(imgWidth > printableArea_w){ imgWidth = printableArea_w; imgHeight = imgWidth/imgBili-2; } if(imgHeight > printableArea_h){ imgHeight = printableArea_h; imgWidth = imgHeight*imgBili-2; } var ImgBox_l = (printableArea_w - imgWidth)/2; var ImgBox_t = (printableArea_h - imgHeight)/2; $("#printableImg").attr("src",newimgUrl); $("#printableImg").attr("data-key",settings.key); $("#printableImg").attr("data-url",settings.imgUrl); $("#printableImg").css({"width":imgWidth,"height":imgHeight}); $("#printableImgBox").css({"width":imgWidth,"height":imgHeight,"top":ImgBox_t,"left":ImgBox_l}); $(".printableImgLeft").val(ImgBox_l); $(".printableImgTop").val(ImgBox_t); dragAndResiza(); }; ImgObj.onerror = function() { }; }; $("#next-btn").unbind("click").bind("click",function(){ var is_key = $("#printableImg").attr("data-key"); if(!is_key){ AlertUtils.tips({ htmlmsg:'<div style="padding:30px">亲，您还没有上传图片！如果不需要图片定制，请点击确定。</div>', scallback:function(){ var activity = BaseInitClass.getQueryString("act"); var printableGdid = $(".printableGdid").val(); var printableColor = $(".printableColor").val(); var url = '/share/sharepage.html?gdid='+printableGdid+'&ukey='+ukey+'&activity='+activity+'&img_print=emptypic&img_pview=emptypic&color='+printableColor+'#fanspage'; window.location.href = url; } }); return false; } var printableColor = $(".printableColor").val(); var printableGdid = $(".printableGdid").val(); var bili = 794/$("#printableArea").width(); var xbili = $("#product-positive").height()/490; var img_shiji_w=513 * xbili; var img_overflow = img_shiji_w - $("#product-positive").width(); var print_bg = $("#product-positive").attr("data-key"); var printableImgBox_h = parseInt($("#printableImgBox").height()*bili-5); var printableImgBox_w = parseInt($("#printableImgBox").width()*bili-5); var printableArea_dx = parseInt($("#printableArea").position().left); var printableArea_dy = parseInt($("#printableArea").position().top); var product_h = parseInt($("#printableImgBox").height()/xbili-5); var product_w = parseInt($("#printableImgBox").width()/xbili-5); var printableImgLeft = $(".printableImgLeft").val(); var printableImgTop = $(".printableImgTop").val(); var dx = parseInt(printableImgLeft*bili); var dy = parseInt(printableImgTop*bili); var xdx = parseInt((Number(printableImgLeft)+printableArea_dx+img_overflow/2)/xbili); var xdy = parseInt((Number(printableImgTop) + printableArea_dy)/xbili); var imgUrl = $("#printableImg").attr("data-url"); var key = $("#printableImg").attr("data-key"); suofangImg({ print_bg:print_bg, imgUrl:imgUrl, w:printableImgBox_w, h:printableImgBox_h, xw:product_w, xh:product_h, dx:dx, dy:dy, xdx:xdx, xdy:xdy, key:key, printableColor:printableColor, printableGdid:printableGdid }); }); function suofangImg(options){ var settings = { print_bg:'', imgUrl:'', w:'', h:'', xw:'', xh:'', dx:'', dy:'', xdx:'', xdy:'', key:'', printableColor:'', printableGdid:'' }; if(options){ $.extend(settings,options); } var imageMogr2 = settings.imgUrl + "?imageMogr2/auto-orient/thumbnail/"+settings.w+"x"; var ximageMogr2 = settings.imgUrl + "?imageMogr2/auto-orient/thumbnail/"+settings.xw+"x"; var xgimg = hechengxgImg({ print_bg:settings.print_bg, w:settings.xw, h:settings.xh, xdx:settings.xdx, xdy:settings.xdy, key:settings.key, sourceLink:ximageMogr2 }); var priimg = hechengImg({ print_bg:settings.print_bg, w:settings.w, h:settings.h, dx:settings.dx, dy:settings.dy, key:settings.key, sourceLink:imageMogr2 }); sendByshareSave({ printableColor:settings.printableColor, printableGdid:settings.printableGdid, xgimg:xgimg, priimg:priimg }); }; function sendByshareSave(options){ var settings = { printableColor:'', printableGdid:'', xgimg:'', priimg:'' }; if(options){ $.extend(settings,options); } var activity = BaseInitClass.getQueryString("act"); var url = '/share/sharepage.html?gdid='+settings.printableGdid+'&ukey='+ukey+'&activity='+activity+'&img_print='+encodeURIComponent(settings.priimg)+'&img_pview='+encodeURIComponent(settings.xgimg)+'&color='+settings.printableColor+'#fanspage'; }; function hechengxgImg(options){ var settings = { print_bg:'', imgboxH:'', imgboxW:'', xdx:'10', xdy:'10', key:'', sourceLink:'' }; if(options){ $.extend(settings,options); } if(settings.xdx<=0){ settings.xdx = 1; } if(settings.xdy <= 0){ settings.xdy = 1; } var imgLink = Qiniu.watermark({ mode: 1, image: settings.sourceLink, dissolve: 100, gravity: "NorthWest", dx: settings.xdx, dy: settings.xdy },settings.print_bg); console.log(imgLink); if(settings.key){ return imgLink; } }; function hechengImg(options){ var settings = { print_bg:'', imgboxH:'', imgboxW:'', dx:'10', dy:'10', key:'', sourceLink:'' }; if(options){ $.extend(settings,options); } if(settings.dx<=0){ settings.dx = 1; } if(settings.dy <= 0){ settings.dy = 1; } var imgLink = Qiniu.watermark({ mode: 1, image: settings.sourceLink, dissolve: 100, gravity: "NorthWest", dx: settings.dx, dy: settings.dy },"printbg.jpg"); console.log(imgLink); if(settings.key){ return imgLink; } }; function uploaderQiNiu(options){ var settings = { token:'', domain:'', bucket:'' }; if(options){ $.extend(settings,options); } var uploader = Qiniu.uploader({ runtimes: 'html5,flash,html4', browse_button: 'pickfiles', uptoken : settings.token, unique_names: false, domain: settings.domain, multi_selection:false, bucket:settings.bucket, container: 'container', max_file_size: '100mb', flash_swf_url: 'js/plupload/Moxie.swf', max_retries: 3, dragdrop: true, drop_element: 'container', chunk_size: '4mb', auto_start: true, init: { 'FilesAdded': function(up, files) { plupload.each(files, function(file) { var progress = new FileProgress(file, 'fsUploadProgress'); progress.setStatus("等待..."); }); }, 'BeforeUpload': function(up, file) { var progress = new FileProgress(file, 'fsUploadProgress'); var chunk_size = plupload.parseSize(this.getOption('chunk_size')); if (up.runtime === 'html5' && chunk_size) { progress.setChunkProgess(chunk_size); } AjaxFunUtils.ajaxInit({url: '/common/gettpl.html?name=progress&ch=sns', type: "GET", yzlogin:true, isloading:true, dataType: 'html', params: '', callback: function(data){ $("body").append(data); AlertUtils.centerDiv({divId:"dzuploadid",type:1}); } }); }, 'UploadProgress': function(up, file) { var progress = new FileProgress(file, 'fsUploadProgress'); var chunk_size = plupload.parseSize(this.getOption('chunk_size')); progress.setProgress(file.percent + "%", up.total.bytesPerSec, chunk_size); $("#progress").find(".text").html(file.percent + "%"); $("#progress").find(".percentage").css({"width":file.percent+"%"}); }, 'FileUploaded': function(up, file, info) { var res = $.parseJSON(info); var sourceLink = settings.domain + "/" + res.key; viewImg({ key:res.key, imgUrl: sourceLink }); }, 'Error': function(up, err, errTip) { }, 'UploadComplete': function() { var num = $('#dzuploadid').attr("data-index"); AlertUtils.centerDivClosed({indexTipDiv:$('#dzuploadid'),type:1,indexNum:num}); }, 'Key': function(up, file) { var d = new Date(); var vYear = d.getFullYear(); var vMon = d.getMonth() + 1; var vDay = d.getDate(); var h = d.getHours(); var m = d.getMinutes(); var s = d.getSeconds(); var datatime = vYear+""+vMon+""+vDay; var randomNum = Math.floor(Math.random()*10000000+1); var key = datatime + "/"+suid+"/"+h+""+m+""+s+""+randomNum+".jpg"; return key } } }); }; }; var selectColorbox = function(odomain){ var mydomain = odomain; var thisGdid = $(".printableGdid").val(); var thisColor = $(".printableColor").val(); var thisType = $(".printableType").val(); checkColor(); function checkColor(){ var colorshtml=''; $.each(goods,function(index,o){ if(o.gdid == thisGdid){ $.each(o.colors,function(oindex,oo){ var colorhtml = '<div class="ColorCircle" data-color="'+oo.val+'" data-title="'+oo.name+'" data-img="'+oo.img+'"><span class="color is-white" style="background:#'+oo.val+'"></span></div>'; if(oo.val == thisColor){ colorhtml = '<div class="ColorCircle is-selected" data-color="'+oo.val+'" data-img="'+oo.img+'"><span class="color is-white" style="background:#'+oo.val+'"></span></div>'; var randomNum = 1; $("#product-positive").css({"background-image":"url("+mydomain+"/"+oo.img+".jpg?v="+randomNum+")"}); $("#product-positive").attr("data-key",oo.img+".jpg"); } colorshtml+=colorhtml; }); $("#selectColors").html(colorshtml); return true; } }); }; $("#selectColorbox").find(".ColorCircle").unbind("click").bind("click",function(){ var inthisColor = $(this).attr("data-color"); var inthisTitle = $(this).attr("data-title"); var thisImg = $(this).attr("data-img"); $(this).addClass("is-selected"); $(this).siblings(".ColorCircle").removeClass("is-selected"); var randomNum = 1; $("#Controls-title").html(inthisTitle); $("#Controls-title").attr("data-color",inthisColor); $("#Controls-title").attr("data-type",thisType); $("#product-positive").css({"background-image":"url("+mydomain+"/"+thisImg+".jpg?v="+randomNum+")"}); $("#product-positive").attr("data-key",thisImg+".jpg"); }); $("#action-Accept").unbind("click").bind("click",function(){ var acceptColor = $("#Controls-title").attr("data-color"); var acceptType = $("#Controls-title").attr("data-type"); $("#printableImgBox").find(".printableColor").val(acceptColor); $("#printableImgBox").find(".printableType").val(acceptType); $(this).parents(".pdefaultMenu").hide(); }); $("#action-Cancel").unbind("click").bind("click",function(){ $(this).parents(".pdefaultMenu").hide(); $("#product-positive").css({"background-image":"url("+mydomain+"/front-"+thisType+"-"+thisColor+".jpg)"}); $("#product-positive").attr("data-key","front-"+thisType+"-"+thisColor+".jpg"); }); }; var selectStylebox = function(odomain){ var mydomain = odomain; var thisGdid = $(".printableGdid").val(); var thisType = $(".printableType").val(); var thisColor = $(".printableColor").val(); var stylehtml=''; $.each(goods,function(index,o){ var typehtml = '<div class="row-flex1 styleCircle" data-gdid="'+o.gdid+'" data-title="'+o.title+'" data-type="'+o.type+'"><span class="bordercolor is-white mr-5"><span class="bg-color"></span></span><span>'+o.title+'</span></div>'; if(o.gdid == thisGdid){ typehtml = '<div class="row-flex1 styleCircle is-selected" data-gdid="'+o.gdid+'" data-title="'+o.title+'" data-type="'+o.type+'"><span class="bordercolor is-white mr-5"><span class="bg-color"></span></span><span>'+o.title+'</span></div>'; $("#Controls-styletitle").attr("data-gdid",thisGdid); $("#Controls-styletitle").attr("data-type",thisType); var randomNum = 1; $("#product-positive").css({"background-image":"url("+mydomain+"/front-"+thisType+"-"+thisColor+".jpg?v="+randomNum+")"}); $("#product-positive").attr("data-key","front-"+thisType+"-"+thisColor+".jpg"); } stylehtml+=typehtml; }); $("#selectStyle").html(stylehtml); $("#selectStylebox").find(".styleCircle").unbind("click").bind("click",function(){ var inthisGdid = $(this).attr("data-gdid"); var inthisTitle = $(this).attr("data-title"); var inthisType = $(this).attr("data-type"); var inthisColor = $(".printableColor").val(); if(inthisType !=thisType){ inthisColor = "ffffff"; } $("#Controls-styletitle").attr("data-gdid",inthisGdid); $("#Controls-styletitle").attr("data-type",inthisType); $("#Controls-styletitle").html(inthisTitle); $(this).addClass("is-selected"); $(this).siblings(".styleCircle").removeClass("is-selected"); var randomNum = 1; $("#product-positive").css({"background-image":"url("+mydomain+"/front-"+inthisType+"-"+inthisColor+".jpg?v="+randomNum+")"}); $("#product-positive").attr("data-key","front-"+inthisType+"-"+inthisColor+".jpg"); }); $("#action-styleAccept").unbind("click").bind("click",function(){ var acceptGdid = $("#Controls-styletitle").attr("data-gdid"); var acceptType = $("#Controls-styletitle").attr("data-type"); if(acceptType !=thisType){ $("#printableImgBox").find(".printableColor").val("ffffff"); }else{ $("#printableImgBox").find(".printableColor").val(thisColor); } $("#printableImgBox").find(".printableGdid").val(acceptGdid); $("#printableImgBox").find(".printableType").val(acceptType); $(this).parents(".pdefaultMenu").hide(); }); $("#action-styleCancel").unbind("click").bind("click",function(){ $(this).parents(".pdefaultMenu").hide(); $("#product-positive").css({"background-image":"url("+mydomain+"/front-"+thisType+"-"+thisColor+".jpg)"}); $("#product-positive").attr("data-key","front-"+thisType+"-"+thisColor+".jpg"); }); }; var footerMenu = function(odomain){ $(".footerMenu").unbind("click").bind("click",function(){ var datatype = $(this).attr("data-type"); var thistitle = $(this).attr("data-title"); $("#" + datatype).show(); if(datatype == "selectStylebox"){ selectStylebox(odomain); }else if(datatype == "selectColorbox"){ selectColorbox(odomain); } }); }; var dzInit = function(){ uploadpicDz(); viewShow(); function viewShow(){ var bodyH = getHeightBody(); var bodyW = $("#bodywidth").width(); var heard_h = $(".headerbox").height(); var footer_h = $(".footerbox").height(); var thisbodyH = bodyH - heard_h - footer_h; var bili = bodyW/750; if(bodyW < thisbodyH){ var abodyW = thisbodyH*0.8; } var thissonh = (thisbodyH+140*bili)/2; var thissonw = thissonh*0.8; var thisson_l = (bodyW - thissonw)/2+3; var thisson_t = (thisbodyH - thissonh)/2; if(thisbodyH < 490){ thisbodyH = 490; } $("#product-positive").css({"height":thisbodyH,"width":bodyW}); $("#printableArea").css({"left":thisson_l,"top":thisson_t,"width":thissonw,"height":thissonh}); }; function newviewShow(){ var bodyW = $("#bodywidth").width(); var bodyH = getHeightBody(); var heard_h = $(".headerbox").height(); var footer_h = $(".footerbox").height(); var thisbodyH = bodyH - heard_h - footer_h; var bili = bodyW/750; if(bodyW < thisbodyH){ var abodyW = thisbodyH*0.8; } var thissonh = (thisbodyH+140*bili)/2; var thissonw = thissonh*0.8; var thisson_l = (bodyW - thissonw)/2+3; var thisson_t = (thisbodyH - thissonh)/2; if(thisbodyH < 490){ thisbodyH = 490; } $("#product-positive").css({"height":thisbodyH,"width":bodyW}); $("#printableArea").css({"left":thisson_l,"top":thisson_t,"width":thissonw,"height":thissonh}); }; $("#help-btn").unbind("click").bind("click",function(){ AlertUtils.centerDiv({"divId":"sns_helpTipbox", type:0, w:"100%", position:"fixed", istop:true, isShade:false, callback:function(){ var bodyHeight = getHeightBody()-45; $("#help-cont").css({"height":bodyHeight}); } }); }); }; return {basedz:basedz,dzInit:dzInit} }();