var ShareView = function(){ var shareViewInit = function(opt){ BaseInitClass.baseInit(); MasonryUtils.shareAndLike(); MasonryUtils.editBtn(); getCommentViewList(); if(opt.type == 'goods'){ goods(); } if(opt.type == 'share'){ MasonryUtils.masonryInit({ masonry:"masonry", islazy:1, callback:function(){ } }); } setImgHeight(); function setImgHeight(){ var bodyH = getHeightBody(); var setH = bodyH*0.7; $("#sliderbox").css({"height":setH}); return setH; } $("#sliderbox").slidepic({autoPlay:false,imgwcallback:function(){ var sliderboxH = $("#sliderbox").height(); var sliderboxW = $("#sliderbox").width(); $("#sliderbox").find("img").each(function(index, element) { $(this).addClass("img_"+index); var ImgObj = new Image(); ImgObj.src = $(this).attr("src"); ImgObj.onload = function() { var thisModH = ImgObj.height; var thisModW = ImgObj.width; var bili = thisModW/thisModH; var left = 0; if(bili>=1){ thisModH = sliderboxH; thisModW = thisModH*bili; left = -(thisModW - sliderboxW)/2; }else{ thisModW = sliderboxW; thisModH = thisModW/bili; }; $(".img_"+index).css({"height":thisModH,"width":thisModW,"margin-left":left}); }; });; $("#viewPicImgBox").find(".mod_01").each(function(index, element) { $(this).setTagPos(); }); $(".shareimg").toggle(function(){ var $thisShow = $(this).siblings(".item-tag"); $thisShow.removeClass("loaded"); },function(){ var $thisShow = $(this).siblings(".item-tag"); $thisShow.addClass("loaded"); }); }}); }; var getCommentViewList = function(){ var shareid = $("#CommentList").attr("data-shareid"); $("#CommentList").loadDataUtils({ url:"/comment/read.html", isPage:true, isdz:true, isOuto:false, isEmpty:true, num_display:0, params: { 'page': 1, 'pagenum':5,"ajax":1 ,'shid':shareid}, getDataHtmlCallback:function(index,o){ if(o.isme){ var reportAndDel = '<span class="fr shareBtn reportComment delCommentBtn" data-cmmid="'+o.cmmid+'" data-shid="'+o.shid+'"><em class="ico ico-delComment"></em></span>'; }else{ var reportAndDel = '<span class="fr shareBtn reportComment reportBtn" data-type="comment" data-cmmid="'+o.cmmid+'" data-shid="'+o.shid+'"><em class="ico ico-reportComment"></em></span>'; } var reuser = ''; if(o.fsuid > 0){ reuser = ' 回复 <span class="b color-blue btn-addpl" data-fsuid="'+o.fsuid+'" data-fuid_uname="'+o.fuid_uname+'">'+o.fuid_uname+'</span>'; } var commentTem = '<li class="rowbox">'+ '<a href="/share/myshares.html?fsuid='+o.suid+'&ukey='+ukey+'"><div class="rowbox avatar useravatar_bg w30 mr-5 mt-5">'+ '<img class="userThumb avatar_loading" src="'+o.avatar[2]+'" data-original="'+o.avatar[1]+'">'+ '</div></a>'+ '<div class="row-flex1 avatar-text">'+ '<div class="commenterWrapper">'+ '<span class="b color-blue btn-addpl" data-fsuid="'+o.suid+'" data-fuid_uname="'+o.fname+'">'+o.fname+'</span>'+ ''+reuser+'<span class="color-999"> • '+o.edttime+'</span>'+ ''+reportAndDel+''+ '</div>'+ '<div class="shareDesc color-555">'+o.comment+'</div>'+ '</div>'+ '</div>'; return commentTem; }, callback:function(){ $(".reportComment").hover(function(){ $(this).addClass("current"); $(this).children(".buttonText").show(); },function(){ $(this).removeClass("current"); $(this).children(".buttonText").hide(); }); $("#CommentList").find("img.avatar_loading").checkImgExists(function(obj,imgurl){ var $myopj = obj; var myimgurl = imgurl; var $thisp = $myopj.parent(".useravatar_bg"); $thisp.css({"background": "url("+myimgurl+") no-repeat","background-size": "cover"}); }); commentBtnBind(); commentDel(); snsReport(); } }); }; var goods = function(){ addCartFun(); getNum(); $("#s_imglsit").find("li").unbind("mouseover").bind("mouseover",function(){ var thisbigimg= $(this).attr("data-bigimg"); $(this).addClass("current"); $(this).siblings("li").removeClass("current"); $("#viewPicImg").attr("src",thisbigimg); }); $(".viewSub").find("li").unbind("click").bind("click",function(){ var subVal = $(this).attr("data-sub"); var thistype = $(this).attr("data-type"); var tagid = $(this).attr("data-tagid"); var iscurrent = $(this).hasClass("current"); if(iscurrent){ if(thistype == "color" || thistype == "size" ){ }else{ $(this).removeClass("current"); $(this).siblings(".thisval").val(''); $(this).siblings(".thisval").attr("data-tagid",''); } }else{ $(this).addClass("current"); $(this).siblings("li").removeClass("current"); $(this).siblings(".thisval").val(subVal); $(this).siblings(".thisval").attr("data-tagid",tagid); } if(thistype == "color" || thistype == "size" ){ var $thisviewColor = $(this).parent(".viewSub"); $thisviewColor.checkboxFn({ checkbox:'hidden' }); } calculateprice(); }); function calculateprice(){ var thisAddprice = 0; var currentNum = $("#other_attributes").find(".current").size(); if(currentNum > 0){ $("#goods_infor_text").show(); $("#goods_infor_numbox").hide(); }else{ $("#goods_infor_text").hide(); $("#goods_infor_numbox").show(); } $("#other_attributes").find(".current").each(function(index, element) { thisAddprice += Number($(this).attr("data-addprice")); }); var combinationId = $("#viewColor-list").find(".thisval").attr("data-tagid")+"_"+$("#viewSize-list").find(".thisval").attr("data-tagid"); if(price_stock[combinationId]){ thisAddprice +=Number(price_stock[combinationId][0]); $("#thisprice").html(exrtitle+thisAddprice.toFixed(2)); $("#goods_infor_num").html(price_stock[combinationId][1]); $("#maxNum").attr("data-max",price_stock[combinationId][1]); getNum(); }else{ var defprice = $("#thisprice").attr("data-defprice"); thisAddprice +=Number(defprice); $("#thisprice").html(exrtitle+thisAddprice.toFixed(2)); } }; var selectCustomBodydata = function(opt){ var actionurl = $("#privateForm").attr("data-action"); var gdid = $("#privateForm").attr("data-gdid"); getBodyDataTip(); function getBodyDataTip(){ AjaxFunUtils.ajaxInit({ url: '/common/gettpl.html?name=b_bodydata&ch=buy', type: "GET", yzlogin:true, dataType: 'html', params: {gdid:gdid}, callback: function(data){ $("body").append(data); getBodyData({gdid:gdid}); addBodyData(); $("#b_privateFrom").checkInput({ buttonDiv:'#button_submit', validatetype:0, submitBtnFn: function (subfrom) { var subdataFrom = subfrom.serializeJson(); var pindata = $.extend(true,opt.dataFrom,subdataFrom); AjaxFunUtils.ajaxInit({url: actionurl, params:pindata, callback:function(res){ if(res.status){ window.location="/myorder/mycart.html"; }else{ AlertUtils.tips({ htmlmsg:'<div style="padding:30px">' + res.msg+'</div>', type:0 }); }; } }) } }); } }); } function closeBodydata(){ var num = $("#b_bodydata_info").attr("data-index"); AlertUtils.centerDivClosed({ indexNum:num, indexTipDiv:$("#b_bodydata_info"), type:1 }); } function getBodyData(options){ var settings = { bdid:'', dataFrom:'', otype:'' }; if(options){ $.extend(settings,options); } AjaxFunUtils.ajaxInit({ url:'/myorder/body_data.html', params:{act:"list"}, callback:function(res){ if(res.status == 1){ var ophtml = ''; var defhtml = '<option value="">新增定制人</option>'; $.each(res.data,function(index,o){ var op = '<option value="'+o.bdid+'" selected="selected">'+o.title+'</option>'; ophtml +=op; }); $("#datanamelist").html(defhtml + ophtml); var thisobdid = $("#datanamelist").val(); getBodyDatainfo({bdid:thisobdid,dataFrom:settings.dataFrom,otype:settings.otype}); selectBody(); }else{ AlertUtils.tips({ type:0, htmlmsg:'<div style="padding:30px">' + res.msg+'</div>', scallback:function(){ closeBodydata({closeDiv:'b_private'}); } }); } } }); } function getBodyDatainfo(options){ var settings = { bdid:'', otype:'', dataFrom:'' }; if(options){ $.extend(settings,options); } var dataUrl = '/myorder/body_data.html'; var gdid = $("#privateForm").attr("data-gdid"); AjaxFunUtils.ajaxInit({ url: dataUrl, yzlogin:true, isloading:true, params: {gdid:gdid,act:"get",bdid:settings.bdid}, callback: function(res){ if(res.status){ $("#bodydatainfo").html(res.data).show(); $("#button_submit").show(); }else{ AlertUtils.tips({ w:350, htmlmsg:'<div style="padding:30px">' + res.msg+'</div>', type:0, scallback:function(){ $("#button_submit").hide(); } }); } var isbodyid = $("#bodyid").val(); if(!isbodyid){ $("#delbodydataBtn").hide(); } getbodyTX(); $("#delbodydataBtn").unbind("click").bind("click",function(){ var actionurl = "/myorder/body_data.html"; var deltype = $(this).attr("data-type"); var bdid = $(this).attr("data-bdid"); AjaxFunUtils.ajaxInit({url: actionurl, params:{bdid:bdid,act:deltype}, callback:function(res){ if(res.status == 1){ getBodyData({bdid:res.data.bdid,otype:1}); }else{ AlertUtils.tips({ w:350, htmlmsg:'<div style="padding:30px">' + res.msg+'</div>' }); } } }); }); $("#txlist").find("dd").unbind("click").bind("click",function(){ $(this).addClass("current"); $(this).siblings("dd").removeClass("current"); var thisVal = $(this).attr("data-val"); $(this).siblings("input").val(thisVal); }); if(!settings.otype){ AlertUtils.centerDiv({ "divId":"b_private", "type":1, callback:function(){} }); } } }); } function getbodyTX(){ $("#txlist").find("dd").each(function(index, element) { var thisval = $(this).attr("data-val"); var thiinval = $(this).siblings("input").val(); if(thisval == thiinval){ $(this).addClass("current"); $(this).siblings("dd").removeClass("current"); } }); } function selectBody(){ $("#datanamelist").change(function(){ var thisobdid = $(this).val(); getBodyDatainfo({bdid:thisobdid,otype:1}); }); } function addBodyData(){ $(".bodydataBtn").unbind("click").bind("click",function(){ var type = $(this).attr("data-type"); var thisval = ''; var gdid = $(this).attr("data-gdid"); if(type == 'edt'){ thisval = $("#datanamelist").val(); } $("#datanamelist").val(""); getBodyDatainfo({otype:1}); }); }; }; var timers = $("#timerbox").attr("data-times"); $("#timerbox").countdownUtils({ timers:timers, callback:function(){ } }); function getNum(){ var maxNum = $("#maxNum").attr("data-max"); if(!maxNum){ maxNum = 99999; } $(".buynum").plus({maxNum:maxNum}); } function isbodydata(){ var opval = $("#datanamelist").find("option").size(); if(opval<=0){ $("#edtbodydataBtn").hide(); }else{ $("#edtbodydataBtn").show(); } } $(".btn-cuscom").unbind("click").bind("click",function(){ $("#custom-list-modalMask").show(); $("#custom-list").show(); $('#custom-list-modalMask').bind("touchmove",function(e){ e.preventDefault(); }); event.stopPropagation(); var bodyH = getHeightBody()-60; $("#custom-cont").css({"height":bodyH}); $("#custom-list-modalMask,.custom-close").unbind("click").bind("click",function(){ $("#custom-list").hide(); $("#custom-list-modalMask").hide(); }); }); function addCartFun(){ $("#privateForm").checkInput({ validatetype:0, submitBtnFn: function (from) { var addflag = $("#viewColor-list").checkboxFn({ checkbox:'hidden' }); var sizeFlag = $("#viewSize-list").checkboxFn({ checkbox:'hidden' }); if(!addflag){ return false; } if(!sizeFlag){ return false; } var thissize = $("#viewSize-list").find(".thisval").val(); var subdataFrom = from.serializeJson(); if(thissize == "bodydata"){ selectCustomBodydata({dataFrom:subdataFrom}); return; } var actionurl = $("#privateForm").attr("data-action"); var pindata = subdataFrom; AjaxFunUtils.ajaxInit({url: actionurl, params:pindata, callback:function(res){ if(res.status){ window.location="/myorder/mycart.html"; }else{ AlertUtils.tips({ htmlmsg:'<div style="padding:30px">' + res.msg+'</div>', type:0 }); }; } }) } }); } }; return {shareViewInit:shareViewInit} }(); 