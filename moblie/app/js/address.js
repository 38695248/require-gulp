define(["jquery","config","base","ajax","checkInput","serializeJson"],function(e,t,n,r){var i="",s=function(){m(i)},o=function(){var n='<div id="addressbox" class="addressbox"><form id="addressform" method="post"><div id="add_headerbox" class="headerbox"><div class="rowbox searchbox"><div class="top_l"> <a href="javascript:void(0);" id="back-address" class="back-address rel" data-level="0"> <span class="b_ico ico-back-h"></span> </a> </div><div class="row-flex1 text-center h2_title">收货地址管理</div></div><div id="address_cont" class="address_cont"><ul id="addressedit" class="jsbox f16 color-333 jsbox_mt0" style="display:none"><li id="address_row" class="rowbox"><div class="row-flex1"><p id="add_str_text">广东省广州市天河区</p><p class="f12 color-999 edit_text">所在地区</p><input id="add_str" name="add_str" type="hidden" /><input id="add_ids" name="add_ids" type="hidden" /></div><div class="ico ico-jt mt-10"></div></li><li id="townSelRow" class="rowbox"><div class="row-flex1"><input id="add_str_2" class="noborder edit_input" name="add_str_2" type="text" placeholder="请选择街道" style="padding-left:0" readonly /><p class="f12 color-999 edit_text">街道</p></div><div class="ico ico-jt mt-10"></div></li><li class="rowbox li_edit"><div class="row-flex1"><input id="add_more" name="add_more" type="text" value="" placeholder="请输入详细地址" class="noborder edit_input" style="padding-left:0" data-validate="isempty" /><p class="f12 color-999 edit_text">详细地址</p></div><div class="ico ico-jt mt-10"></div></li><li class="rowbox li_edit"><div class="row-flex1"><input id="addressee" name="addressee" type="text" value="" placeholder="请输入收货人姓名" class="noborder edit_input" style="padding-left:0" data-validate="isempty" /><p class="f12 color-999 edit_text">收货人姓名</p></div><div class="ico ico-jt mt-10"></div></li><li class="rowbox li_edit"><div class="row-flex1"><input type="text" id="cellphone" name="cellphone" value="" placeholder="请输入收货人手机号码" class="noborder edit_input" style="padding-left:0" data-validate="Mobile" /><p class="f12 color-999 edit_text">收货人手机号码</p></div><div class="ico ico-jt mt-10"></div></li><li class="rowbox li_edit"><div class="row-flex1"><input type="text" id="zip" name="zip" value="" placeholder="请输入邮编" class="noborder edit_input" style="padding-left:0" /><p class="f12 color-999 edit_text">邮编</p></div><div class="ico ico-jt mt-10"></div></li><li class="rowbox" for="sedefault"><div class="row-flex1"><label><input type="checkbox" name="sedefault" id="sedefault" style="width:20px;padding:0; margin-bottom:-10px"/>设置为默认收货地址</label><p class="f12 color-999 edit_text">默认收货地址</p></div><div class="ico ico-jt mt-10"></div></li></ul><ul id="townSelRow_list" class="jsbox jsbox_mt0" style="display:none"></ul><div id="divsionSelect" style="display:none"><ul id="selected" class="jsbox jsbox_mt0" style="display:none"></ul><ul id="forselect" class="jsbox jsbox_mt0"></ul></div></div></div><div class="footerbox rowbox" style="padding:10px 0;z-index:99999"><input id="addrid_edt" name="addrid" type="hidden" /><div class="row-flex1 text-left"><button id="delBtn" type="button" class="btn w150">删除</button></div><div class="row-flex1 text-right"><button type="button" class="btn btn-danger w150 address_sub_btn">保存</button></div></div></form></div>';e("body").append(n);var r=t.base.getHeightBody();e("#add_headerbox").css({height:r,"z-index":99998}),e("#address_cont").css({height:r-60})},u=function(t){o(),t.act=="add"?(e("#add_headerbox").addClass("address_add"),h(),g({act:t.act})):(e("#add_headerbox").addClass("address_edt"),v({act:t.act,addrid:t.addrid,callback:function(e){g({act:"edt"})}})),a(),f(),l(),e("#addressedit").on("click",".li_edit",function(){e(this).addClass("li_edit_current"),e(this).siblings(".li_edit").removeClass("li_edit_current"),e(this).find(".edit_input").focus()}),e("#back-address").on("click",function(){var n=e(this).attr("data-level"),r=e(this).attr("data-state"),i=e(this).attr("data-city");n==0||n==3?e("#addressbox").remove():n==1?t.act=="add"?(h(),e(this).attr("data-level",0),e("#selected").html("").hide()):(e(this).attr("data-level",0),e("#addressedit").show(),e("#divsionSelect").hide()):n==2&&(e(this).attr("data-level",1),e("#selected").find(".li_click").each(function(t,n){var r=e(this).attr("data-level");r==2&&e(this).remove()}),p({thisId:r}))})},a=function(){e("#selected").on("click",".li_click",function(){var t=e(this).attr("data-parentid"),n=e(this).attr("data-level");e("#back-address").attr("data-level",n-1),t>0?(p({thisId:t}),e(this).remove()):(h(),e("#selected").html("").hide()),e("#add_str_2").attr("data-id",""),e("#add_str_2").val(""),e("#townSelRow_list").hide(),e("#divsionSelect").show(),e("#addressedit").hide()})},f=function(){e("#address_row").off("click").on("click",function(){var t=e(this).attr("data-state"),n=e(this).attr("data-city"),r=e(this).attr("data-county");e("#back-address").attr("data-level",2),t>0?(e("#selected").html(""),d({callback:function(r){e.each(r.data,function(n,r){if(r.id==t){var i='<li class="li_click" data-level="'+r.level+'" data-name="'+r.name+'" data-id="'+r.id+'" data-parentid="0">'+r.name+"</li>";e("#selected").append(i);return}}),d({upid:t,callback:function(r){e.each(r.data,function(r,i){if(i.id==n){var s='<li class="li_click" data-level="'+i.level+'" data-name="'+i.name+'" data-id="'+i.id+'" data-parentid="'+t+'">'+i.name+"</li>";e("#selected").append(s);return}}),d({upid:n,callback:function(t){t.data.length<=0?e("#forselect").hide():e("#forselect").show();var r="";e.each(t.data,function(e,t){r+='<li class="li_click" data-level="'+t.level+'" data-name="'+t.name+'" data-id="'+t.id+'" data-parentid="'+n+'">'+t.name+"</li>"}),e("#forselect").html(r)}})}})}}),e("#divsionSelect,#selected").show(),e("#addressedit").hide(),c()):(h(),g({act:"edt"}))})},l=function(){e("#townSelRow").off("click").on("click",function(t){var n=e(this).attr("data-townid");if(n<=0)return!1;d({upid:n,callback:function(t){var n="";e.each(t.data,function(e,t){n+='<li class="li_click" data-level="'+t.level+'" data-name="'+t.name+'" data-id="'+t.id+'" data-isleaf="0">'+t.name+"</li>"}),e("#townSelRow_list").html(n).show(),e("#divsionSelect").hide(),e("#addressedit").hide(),e("#townSelRow_list").off("click").on("click",".li_click",function(){var t=e(this).attr("data-name"),n=e(this).attr("data-id");e("#add_str_2").attr("data-id",n),e("#add_str_2").val(t);var r=e("#address_row").attr("data-state")+"_"+e("#address_row").attr("data-city")+"_"+e("#address_row").attr("data-county")+"_"+n;e("#add_ids").val(r),e("#townSelRow_list").hide(),e("#divsionSelect").hide(),e("#addressedit").show()})}})})},c=function(){e("#forselect").off("click").on("click",".li_click",function(){var t=e(this).attr("data-id"),n=e(this).attr("data-level"),r=e(this).attr("data-name"),i=e(this);e("#back-address").attr("data-level",n),n==1?e("#address_row,#back-address").attr("data-state",t):n==2?e("#address_row,#back-address").attr("data-city",t):n==3&&(e("#address_row,#back-address").attr("data-county",t),e("#add_str_2").val(""),e("#add_str_2").attr("data-id","")),p({thisId:t,thislevel:n,callback:function(s){if(s.data.length<=0||n>2){e("#divsionSelect").hide(),e("#addressedit").show();var o="",u="";e("#selected").find("li").each(function(t,n){var r=e(this).attr("data-name"),i=e(this).attr("data-id");o+=r,u+=i+"_"}),o+=r,u+=t+"_",e("#townSelRow").attr("data-townid",t),e("#add_ids").val(u),e("#add_str_text,#add_str").text(o),e("#add_str").val(o),s.data.length<=0?(e("#forselect").hide(),e("#townSelRow").hide()):(e("#forselect").show(),e("#townSelRow").show())}else e("#selected").append(i).show()}})})},h=function(n){d({callback:function(n){if(n.status==1){var r="";e.each(n.data,function(e,t){r+='<li class="li_click" data-level="'+t.level+'" data-name="'+t.name+'" data-id="'+t.id+'" data-parentid="0" data-isleaf="0">'+t.name+"</li>"}),e("#forselect").html(r).show(),e("#divsionSelect").show(),e("#addressedit").hide(),c()}else t.tip.tips({htmlmsg:'<div style="padding:30px">'+n.msg+"</div>",w:"96%",type:0})}})},p=function(t){d({upid:t.thisId,callback:function(n){var r="";e.each(n.data,function(e,n){r+='<li class="li_click" data-level="'+n.level+'" data-name="'+n.name+'" data-id="'+n.id+'" data-parentid="'+t.thisId+'"  data-isleaf="0">'+n.name+"</li>"}),e("#forselect").html(r).show(),t.callback&&t.callback(n)}})},d=function(e){r.ajaxInit({url:"/common/district_son.html",params:{upid:e.upid},callback:function(t){e.callback&&e.callback(t)}})},v=function(n){r.ajaxInit({url:"/myorder/address.html",params:{act:"get",addrid:n.addrid},callback:function(s){s.status==1&&(e("#addressedit").show(),e("#addrid_edt").val(n.addrid),e("#addressee").val(s.data.addressee),e("#add_str_text").text(s.data.address1),e("#add_str").val(s.data.address1),e("#add_ids").val(s.data.state+"_"+s.data.city+"_"+s.data.county+"_"+s.data.town),e("#add_more").val(s.data.more),e("#zip").val(s.data.zip),e("#cellphone").val(s.data.cellphone),s.data.town?e("#add_str_2").val(s.data.address2):e("#townSelRow").hide(),s.data.addrid==i&&e("#sedefault").attr("checked","checked"),e("#address_row").attr("data-state",s.data.state),e("#address_row").attr("data-city",s.data.city),e("#address_row").attr("data-county",s.data.county),e("#townSelRow").attr("data-townid",s.data.county),e("#delBtn").show().unbind("click").bind("click",function(){r.ajaxInit({url:"/myorder/address.html",params:{act:"del",addrid:n.addrid},callback:function(n){n.status==1?(m(),t.tip.tips({htmlmsg:'<div style="padding:30px">'+n.msg+"</div>",w:"96%",type:0}),e("#addressbox").remove()):t.tip.tips({htmlmsg:'<div style="padding:30px">'+n.msg+"</div>",w:"96%",type:0})}})}),n.callback&&n.callback(s))}})},m=function(t){r.ajaxInit({url:"/myorder/address.html",params:{act:"list"},callback:function(t){var n=t.data;if(n.length<=0)return e("#addrid").html('<p id="newaddress" class="addAddressBtn" data-address="0" data-act="add" style="padding:0 5px; margin:5px 0">请填写收货人信息</p>'),y(),!1;var r="";e.each(n,function(e,t){var n=t.address1+" "+t.address2+" "+t.more+" "+t.addressee+" "+t.cellphone,s="";t.default==1&&(s='checked="checked"',i=t.addrid);var o='<li class="rowbox mt-5"><div class="row-flex1 rowbox"><input name="addrid" id="'+t.addrid+'" type="radio" value="'+t.addrid+'" '+s+'><label style="line-height:20px" for="'+t.addrid+'">'+n+'</label></div><div class="w100 text-right"><a href="javascript:void(0);" class="addAddressBtn"  data-address="1" data-addrid="'+t.addrid+'" data-act="edt">编辑<div class="ico ico-jt ml-5"></div></a></div></li>';r+=o}),e("#addrid").html(r),y()}})},g=function(n){e("#addressform").checkInput({button:".address_sub_btn",submitBtnFn:function(i){var s=i.serializeJson();s.act=n.act,r.ajaxInit({url:"/myorder/address.html",params:s,callback:function(n){n.status==1?t.tip.tips({htmlmsg:'<div style="padding:30px">'+n.msg+"</div>",w:"96%",type:0,callback:function(){m(),e("#addressbox").remove()}}):t.tip.tips({htmlmsg:'<div style="padding:30px">'+n.msg+"</div>",w:"96%",type:0})}})}})},y=function(){e(".addAddressBtn").unbind("click").bind("click",function(){var t=e(this).attr("data-address"),n=e(this).attr("data-addrid"),r=e(this).attr("data-act");u({act:r,addrid:n})}),e(".wxAddressBtn").unbind("click").bind("click",function(){var n=e(this).attr("data-addrid");r.ajaxInit({url:"/myorder/address.html?act=weixin_sign",params:{},callback:function(n){if(n.status==1){var i=n.data.sign_info;o();function s(){WeixinJSBridge.invoke("editAddress",i,function(n){var i={};i.act="add",i.nickname=n.username,i.cellphone=n.telNumber,i.zip=n.addressPostalCode,i.address1=n.addressCitySecondStageName+" "+n.addressCountiesThirdStageName+" "+n.addressDetailInfo,r.ajaxInit({url:"/myorder/address.html",params:i,callback:function(n){n.status==1?e("#sedefault").attr("checked"):t.tip.tips({htmlmsg:'<div style="padding:30px">'+n.msg+"</div>",w:"96%",type:0})}})})}function o(){typeof WeixinJSBridge=="undefined"?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",s,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",s),document.attachEvent("onWeixinJSBridgeReady",s)):s()}}}})})};return{init:s,getAddress:m}});