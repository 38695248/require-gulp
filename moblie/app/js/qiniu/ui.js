function FileProgress(e,t){this.fileProgressID=e.id,this.file=e,this.opacity=100,this.height=0,this.fileProgressWrapper=$("#"+this.fileProgressID);if(!this.fileProgressWrapper.length){this.fileProgressWrapper=$("<tr></tr>");var n=this.fileProgressWrapper;n.attr("id",this.fileProgressID).addClass("progressContainer");var r=$("<td/>");r.addClass("progressName").text(e.name);var i=plupload.formatSize(e.size).toUpperCase(),s=$("<td/>");s.addClass("progressFileSize").text(i);var o=$("<td/>"),u=$("<div/>");u.addClass("info");var a=$("<div/>");a.addClass("progress progress-striped");var f=$("<div/>");f.addClass("progress-bar progress-bar-info").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%");var l=$("<span class=sr-only />");l.text(i);var c=$("<a href=# />");c.hide().addClass("progressCancel").text(""),f.append(l),a.append(f),u.append(a),u.append(c);var h=$('<div class="status text-center"/>');u.append(h),o.append(u),n.append(r),n.append(s),n.append(o),$("#"+t).append(n)}else this.reset();this.height=this.fileProgressWrapper.offset().top,this.setTimer(null)}FileProgress.prototype.setTimer=function(e){this.fileProgressWrapper.FP_TIMER=e},FileProgress.prototype.getTimer=function(e){return this.fileProgressWrapper.FP_TIMER||null},FileProgress.prototype.reset=function(){this.fileProgressWrapper.attr("class","progressContainer"),this.fileProgressWrapper.find("td .progress .progress-bar-info").attr("aria-valuenow",0).width("0%").find("span").text(""),this.appear()},FileProgress.prototype.setChunkProgess=function(e){var t=Math.ceil(this.file.size/e);if(t===1)return!1;var n=$('<button class="btn btn-default">查看分块上传进度</button>'),r=$('<tr class="chunk-status-tr"><td colspan=3></td></tr>'),i=$("<div/>");for(var s=1;s<=t;s++){var o=$('<div class="col-md-2"/>'),u=$('<div class="progress progress-striped"></div'),a=$("<div/>");a.addClass("progress-bar progress-bar-info text-left").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%").attr("id",this.file.id+"_"+s).text("");var f=$("<span/>");f.addClass("chunk-status").text(),u.append(a),u.append(f),o.append(u),i.append(o)}this.fileProgressWrapper.find("td>div").append(n),r.hide().find("td").append(i),r.insertAfter(this.fileProgressWrapper)},FileProgress.prototype.setProgress=function(e,t,n){this.fileProgressWrapper.attr("class","progressContainer green");var r=this.file,i=r.loaded,s=plupload.formatSize(i).toUpperCase(),o=plupload.formatSize(t).toUpperCase(),u=this.fileProgressWrapper.find("td .progress").find(".progress-bar-info");this.fileProgressWrapper.find(".status").text("已上传: "+s+" 上传速度： "+o+"/s"),e=parseInt(e,10),r.status!==plupload.DONE&&e===100&&(e=99),u.attr("aria-valuenow",e).css("width",e+"%");if(n){var a=Math.ceil(r.size/n);if(a===1)return!1;var f=Math.ceil(i/n),l,c;for(var h=0;h<f;h++)l=$("#"+r.id+"_"+h),l.width("100%").removeClass().addClass("alert-success").attr("aria-valuenow",100),c="块"+h+"上传进度100%",l.next().html(c);var p=$("#"+r.id+"_"+f),d;if(f<a)i%n?d=(i%n/n*100).toFixed(2):(d=100,p.removeClass().addClass("alert-success"));else{var v=r.size-n*(a-1),m=r.size-i;m%v?d=(i%n/v*100).toFixed(2):(d=100,p.removeClass().addClass("alert-success"))}p.width(d+"%"),p.attr("aria-valuenow",d),c="块"+f+"上传进度"+d+"%",p.next().html(c)}this.appear()},FileProgress.prototype.setComplete=function(e,t){var n=this.fileProgressWrapper.find("td:eq(2) .progress"),r=$.parseJSON(t),i;if(r.url)i=r.url,str="<div><strong>Link:</strong><a href="+r.url+" target='_blank' > "+r.url+"</a></div>"+"<div class=hash><strong>Hash:</strong>"+r.hash+"</div>";else{var s=e.getOption("domain");i=s+encodeURI(r.key);var o=s+r.key;str="<div><strong>Link:</strong><a href="+i+" target='_blank' > "+o+"</a></div>"+"<div class=hash><strong>Hash:</strong>"+r.hash+"</div>"}n.html(str).removeClass().next().next(".status").hide();var u=this.fileProgressWrapper.find(".progressName"),a="?imageView2/1/w/100/h/100",f=function(e){var t,n="",r=["png","jpg","jpeg","gif","bmp"],i=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!e||!i.test(e))return!1;t=i.exec(e),n=t[1].toLowerCase();for(var s=0,o=r.length;s<o;s++)if(n===r[s])return!0;return!1},l=f(i),c=$('<div class="Wrapper"/>'),h=$('<div class="imgWrapper col-md-3"/>'),p=$('<a class="linkWrapper" target="_blank"/>'),d=$('<img src="loading.gif"/>');u.append(c);if(!l)d.attr("src","default.png"),c.addClass("default"),h.append(d),c.append(h);else{p.append(d),h.append(p),c.append(h);var v=new Image;/imageView/.test(i)||(i+=a),$(v).attr("src",i);var m=340;$(v).on("load",function(){function e(e,t,n){$("#myModal-img").modal();var r=$("#myModal-img").find(".modal-body");n<=300&&$("#myModal-img").find(".text-warning").show();var i=new Image;r.find("img").attr("src","loading.gif"),i.onload=function(){r.find("img").attr("src",e).data("key",t).data("h",n),r.find(".modal-body-wrapper").find("a").attr("href",e)},i.src=e}d.attr("src",i),p.attr("href",i).attr("title","查看原图");var t=$('<div class="infoWrapper col-md-6"></div>'),n=$('<a class="fopLink"/>');n.attr("data-key",r.key).text("查看处理效果"),t.append(n),n.on("click",function(){var t=$(this).data("key"),n=parseInt($(this).parents(".Wrapper").find(".origin-height").text(),10);n>$(window).height()-m?n=parseInt($(window).height()-m,10):n=parseInt(n,10)||300;var r=[];r.push({fop:"imageView2",mode:3,h:n,q:100,format:"png"}),r.push({fop:"watermark",mode:1,image:"http://www.b1.qiniudn.com/images/logo-2.png",dissolve:100,gravity:"SouthEast",dx:100,dy:100});var i=Qiniu.pipeline(r,t);return $("#myModal-img").on("hide.bs.modal",function(){$("#myModal-img").find(".btn-default").removeClass("disabled"),$("#myModal-img").find(".text-warning").hide()}).on("show.bs.modal",function(){$("#myModal-img").find(".imageView").find("a:eq(0)").addClass("disabled"),$("#myModal-img").find(".watermark").find("a:eq(3)").addClass("disabled"),$("#myModal-img").find(".text-warning").hide()}),e(i,t,n),!1});var s=Qiniu.detectIEVersion();if(!(s&&s<=9)){var o=Qiniu.exif(r.key);if(o){var u=$('<a href="" target="_blank">查看exif</a>');u.attr("href",i+"?exif"),t.append(u)}var a=Qiniu.imageInfo(r.key),f=$("<div/>"),l='<div>格式：<span class="origin-format">'+a.format+"</span></div>"+'<div>宽度：<span class="orgin-width">'+a.width+"px</span></div>"+'<div>高度：<span class="origin-height">'+a.height+"px</span></div>";f.html(l),t.append(f)}c.append(t)}).on("error",function(){d.attr("src","default.png"),c.addClass("default")})}},FileProgress.prototype.setError=function(){this.fileProgressWrapper.find("td:eq(2)").attr("class","text-warning"),this.fileProgressWrapper.find("td:eq(2) .progress").css("width",0).hide(),this.fileProgressWrapper.find("button").hide(),this.fileProgressWrapper.next(".chunk-status-tr").hide()},FileProgress.prototype.setCancelled=function(e){var t="progressContainer";e||(t+=" red"),this.fileProgressWrapper.attr("class",t),this.fileProgressWrapper.find("td .progress .progress-bar-info").css("width",0)},FileProgress.prototype.setStatus=function(e,t){t||this.fileProgressWrapper.find(".status").text(e).attr("class","status text-left")},FileProgress.prototype.appear=function(){this.getTimer()!==null&&(clearTimeout(this.getTimer()),this.setTimer(null));if(this.fileProgressWrapper[0].filters)try{this.fileProgressWrapper[0].filters.item("DXImageTransform.Microsoft.Alpha").opacity=100}catch(e){this.fileProgressWrapper.css("filter","progid:DXImageTransform.Microsoft.Alpha(opacity=100)")}else this.fileProgressWrapper.css("opacity",1);this.fileProgressWrapper.css("height",""),this.height=this.fileProgressWrapper.offset().top,this.opacity=100,this.fileProgressWrapper.show()};