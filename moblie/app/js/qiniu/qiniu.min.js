function FileProgress(e,t){this.fileProgressID=e.id,this.file=e,this.opacity=100,this.height=0,this.fileProgressWrapper=$("#"+this.fileProgressID);if(!this.fileProgressWrapper.length){this.fileProgressWrapper=$("<tr></tr>");var n=this.fileProgressWrapper;n.attr("id",this.fileProgressID).addClass("progressContainer");var r=$("<td/>");r.addClass("progressName").text(e.name);var i=plupload.formatSize(e.size).toUpperCase(),s=$("<td/>");s.addClass("progressFileSize").text(i);var o=$("<td/>"),u=$("<div/>");u.addClass("info");var a=$("<div/>");a.addClass("progress progress-striped");var f=$("<div/>");f.addClass("progress-bar progress-bar-info").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%");var l=$("<span class=sr-only />");l.text(i);var c=$("<a href=# />");c.hide().addClass("progressCancel").text(""),f.append(l),a.append(f),u.append(a),u.append(c);var h=$('<div class="status text-center"/>');u.append(h),o.append(u),n.append(r),n.append(s),n.append(o),$("#"+t).append(n)}else this.reset();this.height=this.fileProgressWrapper.offset().top,this.setTimer(null)}function QiniuJsSDK(){this.detectIEVersion=function(){var e=4,t=document.createElement("div"),n=t.getElementsByTagName("i");while(t.innerHTML="<!--[if gt IE "+e+"]><i></i><![endif]-->",n[0])e++;return e>4?e:!1},this.isImage=function(e){var t,n="",r=["png","jpg","jpeg","gif","bmp"],i=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!e||!i.test(e))return!1;t=i.exec(e),n=t[1].toLowerCase();for(var s=0,o=r.length;s<o;s++)if(n===r[s])return!0;return!1},this.getFileExtension=function(e){var t=e.split("."),n;return t.length===1||t[0]===""&&t.length===2?n="":n=t.pop().toLowerCase(),n},this.utf8_encode=function(e){if(e===null||typeof e=="undefined")return"";var t=e+"",n="",r,i,s=0;r=i=0,s=t.length;for(var o=0;o<s;o++){var u=t.charCodeAt(o),a=null;if(u<128)i++;else if(u>127&&u<2048)a=String.fromCharCode(u>>6|192,u&63|128);else if(u&63488^!0)a=String.fromCharCode(u>>12|224,u>>6&63|128,u&63|128);else{if(u&64512^!0)throw new RangeError("Unmatched trail surrogate at "+o);var f=t.charCodeAt(++o);if(f&64512^!0)throw new RangeError("Unmatched lead surrogate at "+(o-1));u=((u&1023)<<10)+(f&1023)+65536,a=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,u&63|128)}a!==null&&(i>r&&(n+=t.slice(r,i)),n+=a,r=i=o+1)}return i>r&&(n+=t.slice(r,s)),n},this.base64_encode=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n,r,i,s,o,u,a,f,l=0,c=0,h="",p=[];if(!e)return e;e=this.utf8_encode(e+"");do n=e.charCodeAt(l++),r=e.charCodeAt(l++),i=e.charCodeAt(l++),f=n<<16|r<<8|i,s=f>>18&63,o=f>>12&63,u=f>>6&63,a=f&63,p[c++]=t.charAt(s)+t.charAt(o)+t.charAt(u)+t.charAt(a);while(l<e.length);h=p.join("");switch(e.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"="}return h},this.URLSafeBase64Encode=function(e){return e=this.base64_encode(e),e.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(e){var t={};return window.XMLHttpRequest?t=new XMLHttpRequest:t=new ActiveXObject("Microsoft.XMLHTTP"),t},this.parseJSON=function(e){if(window.JSON&&window.JSON.parse)return window.JSON.parse(e);if(e===null)return e;if(typeof e=="string"){e=this.trim(e);if(e&&/^[\],:{}\s]*$/.test(e.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return function(){return e}()}},this.trim=function(e){return e===null?"":this.trim.call(e)};var e=this;this.uploader=function(t){if(!t.domain)throw"uptoken_url or domain is required!";if(!t.browse_button)throw"browse_button is required!";var n={},r=t.init&&t.init.Error,i=t.init&&t.init.FileUploaded;t.init.Error=function(){},t.init.FileUploaded=function(){},e.uptoken_url=t.uptoken_url,e.token="",e.key_handler=typeof t.init.Key=="function"?t.init.Key:"",this.domain=t.domain;var s="",o=function(){var n=e.detectIEVersion(),r,i,s,o=mOxie.Env.browser==="Safari"&&mOxie.Env.version<=5&&mOxie.Env.os==="Windows"&&mOxie.Env.osVersion==="7"||mOxie.Env.browser==="Safari"&&mOxie.Env.os==="iOS"&&mOxie.Env.osVersion==="7";n&&n<=9&&t.chunk_size&&t.runtimes.indexOf("flash")>=0?t.chunk_size=0:o?t.chunk_size=0:(r=20,i=4<<r,s=plupload.parseSize(t.chunk_size),s>i&&(t.chunk_size=i))};o();var u=function(){if(!t.uptoken){var n=e.createAjax();n.open("GET",e.uptoken_url,!0),n.setRequestHeader("If-Modified-Since","0"),n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){var t=e.parseJSON(n.responseText);e.token=t.uptoken}},n.send()}else e.token=t.uptoken},a=function(n,r,i){var s="",o=!1;if(!t.save_key){o=n.getOption&&n.getOption("unique_names"),o=o||n.settings&&n.settings.unique_names;if(o){var u=e.getFileExtension(r.name);s=u?r.id+"."+u:r.id}else typeof i=="function"?s=i(n,r):s=r.name}return s};plupload.extend(n,t,{url:"http://up.qiniu.com",multipart_params:{token:""}});var f=new plupload.Uploader(n);return f.bind("Init",function(e,t){u()}),f.init(),f.bind("FilesAdded",function(e,t){var n=e.getOption&&e.getOption("auto_start");n=n||e.settings&&e.settings.auto_start,n&&plupload.each(t,function(t,n){e.start()}),e.refresh()}),f.bind("BeforeUpload",function(n,r){s="";var i=function(n,r,i){var s;t.save_key?s={token:e.token}:s={key:a(n,r,i),token:e.token};var o=t.x_vars;if(o!==undefined&&typeof o=="object")for(var u in o)o.hasOwnProperty(u)&&(typeof o[u]=="function"?s["x:"+u]=o[u](n,r):typeof o[u]!="object"&&(s["x:"+u]=o[u]));n.setOption({url:"http://upload.qiniu.com/",multipart:!0,chunk_size:undefined,multipart_params:s})},o=n.getOption&&n.getOption("chunk_size");o=o||n.settings&&n.settings.chunk_size;if(f.runtime==="html5"&&o)if(r.size<o)i(n,r,e.key_handler);else{var u=localStorage.getItem(r.name),l=o;if(u){u=JSON.parse(u);var c=(new Date).getTime(),h=u.time||0,p=864e5;c-h<p?u.percent!==100?r.size===u.total?(r.percent=u.percent,r.loaded=u.offset,s=u.ctx,u.offset+l>r.size&&(l=r.size-u.offset)):localStorage.removeItem(r.name):localStorage.removeItem(r.name):localStorage.removeItem(r.name)}n.setOption({url:"http://upload.qiniu.com/mkblk/"+l,multipart:!1,chunk_size:o,required_features:"chunks",headers:{Authorization:"UpToken "+e.token},multipart_params:{}})}else i(n,r,e.key_handler)}),f.bind("ChunkUploaded",function(t,n,r){var i=e.parseJSON(r.response);s=s?s+","+i.ctx:i.ctx;var o=r.total-r.offset,u=t.getOption&&t.getOption("chunk_size");u=u||t.settings&&t.settings.chunk_size,o<u&&t.setOption({url:"http://upload.qiniu.com/mkblk/"+o}),localStorage.setItem(n.name,JSON.stringify({ctx:s,percent:n.percent,total:r.total,offset:r.offset,time:(new Date).getTime()}))}),f.bind("Error",function(t){return function(n,r){var i="",s=r.file;if(s){switch(r.code){case plupload.FAILED:i="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var o=n.getOption&&n.getOption("max_file_size");o=o||n.settings&&n.settings.max_file_size,i="浏览器最大可上传"+o+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:i="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:var u=e.parseJSON(r.response),a=u.error;switch(r.status){case 400:i="请求报文格式错误。";break;case 401:i="客户端认证授权失败。请重试或提交反馈。";break;case 405:i="客户端请求错误。请重试或提交反馈。";break;case 579:i="资源上传成功，但回调失败。";break;case 599:i="网络连接异常。请重试或提交反馈。";break;case 614:i="文件已存在。";try{u=e.parseJSON(u.error),a=u.error||"file exists"}catch(l){a=u.error||"file exists"}break;case 631:i="指定空间不存在。";break;case 701:i="上传数据块校验出错。请重试或提交反馈。";break;default:i="未知错误。"}i=i+"("+r.status+"："+a+")";break;case plupload.SECURITY_ERROR:i="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:i="上传失败。请稍后再试。";break;case plupload.IO_ERROR:i="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:i="网站配置错误。请联系网站管理员。",f.destroy();break;default:i=r.message+r.details}t&&t(n,r,i)}n.refresh()}}(r)),f.bind("FileUploaded",function(n){return function(r,i,o){var u=function(r,i,s){if(t.downtoken_url){var o=e.createAjax();o.open("POST",t.downtoken_url,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(o.readyState===4)if(o.status===200){var t;try{t=e.parseJSON(o.responseText)}catch(u){throw"invalid json format"}var a={};plupload.extend(a,e.parseJSON(s),t),n&&n(r,i,JSON.stringify(a))}else f.trigger("Error",{status:o.status,response:o.responseText,file:i,code:plupload.HTTP_ERROR})},o.send("key="+e.parseJSON(s).key+"&domain="+t.domain)}else n&&n(r,i,s)},l=e.parseJSON(o.response);s=s?s:l.ctx;if(s){var c="";t.save_key||(c=a(r,i,e.key_handler),c=c?"/key/"+e.URLSafeBase64Encode(c):"");var h=t.x_vars,p="",d="";if(h!==undefined&&typeof h=="object")for(var v in h)h.hasOwnProperty(v)&&(typeof h[v]=="function"?p=e.URLSafeBase64Encode(h[v](r,i)):typeof h[v]!="object"&&(p=e.URLSafeBase64Encode(h[v])),d+="/x:"+v+"/"+p);var m="http://upload.qiniu.com/mkfile/"+i.size+c+d,g=e.createAjax();g.open("POST",m,!0),g.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),g.setRequestHeader("Authorization","UpToken "+e.token),g.onreadystatechange=function(){if(g.readyState===4){localStorage.removeItem(i.name);if(g.status===200){var e=g.responseText;u(r,i,e)}else f.trigger("Error",{status:g.status,response:g.responseText,file:i,code:-200})}},g.send(s)}else u(r,i,o.response)}}(i)),f},this.getUrl=function(e){if(!e)return!1;e=encodeURI(e);var t=this.domain;return t.slice(t.length-1)!=="/"&&(t+="/"),t+e},this.imageView2=function(e,t){var n=e.mode||"",r=e.w||"",i=e.h||"",s=e.quality||"",o=e.format||"";if(!n)return!1;if(!r&&!i)return!1;var u="imageView2/"+n;return u+=r?"/w/"+r:"",u+=i?"/h/"+i:"",u+=s?"/q/"+s:"",u+=o?"/format/"+o:"",t&&(u=this.getUrl(t)+"?"+u),u},this.imageMogr2=function(e,t){var n=e["auto-orient"]||"",r=e.thumbnail||"",i=e.strip||"",s=e.gravity||"",o=e.crop||"",u=e.quality||"",a=e.rotate||"",f=e.format||"",l=e.blur||"",c="imageMogr2";return c+=n?"/auto-orient":"",c+=r?"/thumbnail/"+r:"",c+=i?"/strip":"",c+=s?"/gravity/"+s:"",c+=u?"/quality/"+u:"",c+=o?"/crop/"+o:"",c+=a?"/rotate/"+a:"",c+=f?"/format/"+f:"",c+=l?"/blur/"+l:"",t&&(c=this.getUrl(t)+"?"+c),c},this.watermark=function(e,t){var n=e.mode;if(!n)return!1;var r="watermark/"+n;if(n===1){var i=e.image||"";if(!i)return!1;r+=i?"/image/"+this.URLSafeBase64Encode(i):""}else{if(n!==2)return!1;var s=e.text?e.text:"",o=e.font?e.font:"",u=e.fontsize?e.fontsize:"",a=e.fill?e.fill:"";if(!s)return!1;r+=s?"/text/"+this.URLSafeBase64Encode(s):"",r+=o?"/font/"+this.URLSafeBase64Encode(o):"",r+=u?"/fontsize/"+u:"",r+=a?"/fill/"+this.URLSafeBase64Encode(a):""}var f=e.dissolve||"",l=e.gravity||"",c=e.dx||"",h=e.dy||"";return r+=f?"/dissolve/"+f:"",r+=l?"/gravity/"+l:"",r+=c?"/dx/"+c:"",r+=h?"/dy/"+h:"",t&&(r=this.getUrl(t)+"?"+r),r},this.imageInfo=function(e){if(!e)return!1;var t=this.getUrl(e)+"?imageInfo",n=this.createAjax(),r,i=this;return n.open("GET",t,!1),n.onreadystatechange=function(){n.readyState===4&&n.status===200&&(r=i.parseJSON(n.responseText))},n.send(),r},this.exif=function(e){if(!e)return!1;var t=this.getUrl(e)+"?exif",n=this.createAjax(),r,i=this;return n.open("GET",t,!1),n.onreadystatechange=function(){n.readyState===4&&n.status===200&&(r=i.parseJSON(n.responseText))},n.send(),r},this.get=function(e,t){return!t||!e?!1:e==="exif"?this.exif(t):e==="imageInfo"?this.imageInfo(t):!1},this.pipeline=function(e,t){var n=Object.prototype.toString.call(e)==="[object Array]",r,i,s="";if(n){for(var o=0,u=e.length;o<u;o++){r=e[o];if(!r.fop)return!1;switch(r.fop){case"watermark":s+=this.watermark(r)+"|";break;case"imageView2":s+=this.imageView2(r)+"|";break;case"imageMogr2":s+=this.imageMogr2(r)+"|";break;default:i=!0}if(i)return!1}if(t){s=this.getUrl(t)+"?"+s;var a=s.length;s.slice(a-1)==="|"&&(s=s.slice(0,a-1))}return s}return!1}}FileProgress.prototype.setTimer=function(e){this.fileProgressWrapper.FP_TIMER=e},FileProgress.prototype.getTimer=function(e){return this.fileProgressWrapper.FP_TIMER||null},FileProgress.prototype.reset=function(){this.fileProgressWrapper.attr("class","progressContainer"),this.fileProgressWrapper.find("td .progress .progress-bar-info").attr("aria-valuenow",0).width("0%").find("span").text(""),this.appear()},FileProgress.prototype.setChunkProgess=function(e){var t=Math.ceil(this.file.size/e);if(t===1)return!1;var n=$('<button class="btn btn-default">查看分块上传进度</button>'),r=$('<tr class="chunk-status-tr"><td colspan=3></td></tr>'),i=$("<div/>");for(var s=1;s<=t;s++){var o=$('<div class="col-md-2"/>'),u=$('<div class="progress progress-striped"></div'),a=$("<div/>");a.addClass("progress-bar progress-bar-info text-left").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%").attr("id",this.file.id+"_"+s).text("");var f=$("<span/>");f.addClass("chunk-status").text(),u.append(a),u.append(f),o.append(u),i.append(o)}this.fileProgressWrapper.find("td>div").append(n),r.hide().find("td").append(i),r.insertAfter(this.fileProgressWrapper)},FileProgress.prototype.setProgress=function(e,t,n){this.fileProgressWrapper.attr("class","progressContainer green");var r=this.file,i=r.loaded,s=plupload.formatSize(i).toUpperCase(),o=plupload.formatSize(t).toUpperCase(),u=this.fileProgressWrapper.find("td .progress").find(".progress-bar-info");this.fileProgressWrapper.find(".status").text("已上传: "+s+" 上传速度： "+o+"/s"),e=parseInt(e,10),r.status!==plupload.DONE&&e===100&&(e=99),u.attr("aria-valuenow",e).css("width",e+"%");if(n){var a=Math.ceil(r.size/n);if(a===1)return!1;var f=Math.ceil(i/n),l,c;for(var h=0;h<f;h++)l=$("#"+r.id+"_"+h),l.width("100%").removeClass().addClass("alert-success").attr("aria-valuenow",100),c="块"+h+"上传进度100%",l.next().html(c);var p=$("#"+r.id+"_"+f),d;if(f<a)i%n?d=(i%n/n*100).toFixed(2):(d=100,p.removeClass().addClass("alert-success"));else{var v=r.size-n*(a-1),m=r.size-i;m%v?d=(i%n/v*100).toFixed(2):(d=100,p.removeClass().addClass("alert-success"))}p.width(d+"%"),p.attr("aria-valuenow",d),c="块"+f+"上传进度"+d+"%",p.next().html(c)}this.appear()},FileProgress.prototype.setComplete=function(e,t){var n=this.fileProgressWrapper.find("td:eq(2) .progress"),r=$.parseJSON(t),i;if(r.url)i=r.url,str="<div><strong>Link:</strong><a href="+r.url+" target='_blank' > "+r.url+"</a></div>"+"<div class=hash><strong>Hash:</strong>"+r.hash+"</div>";else{var s=e.getOption("domain");i=s+encodeURI(r.key);var o=s+r.key;str="<div><strong>Link:</strong><a href="+i+" target='_blank' > "+o+"</a></div>"+"<div class=hash><strong>Hash:</strong>"+r.hash+"</div>"}n.html(str).removeClass().next().next(".status").hide();var u=this.fileProgressWrapper.find(".progressName"),a="?imageView2/1/w/100/h/100",f=function(e){var t,n="",r=["png","jpg","jpeg","gif","bmp"],i=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!e||!i.test(e))return!1;t=i.exec(e),n=t[1].toLowerCase();for(var s=0,o=r.length;s<o;s++)if(n===r[s])return!0;return!1},l=f(i),c=$('<div class="Wrapper"/>'),h=$('<div class="imgWrapper col-md-3"/>'),p=$('<a class="linkWrapper" target="_blank"/>'),d=$('<img src="loading.gif"/>');u.append(c);if(!l)d.attr("src","default.png"),c.addClass("default"),h.append(d),c.append(h);else{p.append(d),h.append(p),c.append(h);var v=new Image;/imageView/.test(i)||(i+=a),$(v).attr("src",i);var m=340;$(v).on("load",function(){function e(e,t,n){$("#myModal-img").modal();var r=$("#myModal-img").find(".modal-body");n<=300&&$("#myModal-img").find(".text-warning").show();var i=new Image;r.find("img").attr("src","loading.gif"),i.onload=function(){r.find("img").attr("src",e).data("key",t).data("h",n),r.find(".modal-body-wrapper").find("a").attr("href",e)},i.src=e}d.attr("src",i),p.attr("href",i).attr("title","查看原图");var t=$('<div class="infoWrapper col-md-6"></div>'),n=$('<a class="fopLink"/>');n.attr("data-key",r.key).text("查看处理效果"),t.append(n),n.on("click",function(){var t=$(this).data("key"),n=parseInt($(this).parents(".Wrapper").find(".origin-height").text(),10);n>$(window).height()-m?n=parseInt($(window).height()-m,10):n=parseInt(n,10)||300;var r=[];r.push({fop:"imageView2",mode:3,h:n,q:100,format:"png"}),r.push({fop:"watermark",mode:1,image:"http://www.b1.qiniudn.com/images/logo-2.png",dissolve:100,gravity:"SouthEast",dx:100,dy:100});var i=Qiniu.pipeline(r,t);return $("#myModal-img").on("hide.bs.modal",function(){$("#myModal-img").find(".btn-default").removeClass("disabled"),$("#myModal-img").find(".text-warning").hide()}).on("show.bs.modal",function(){$("#myModal-img").find(".imageView").find("a:eq(0)").addClass("disabled"),$("#myModal-img").find(".watermark").find("a:eq(3)").addClass("disabled"),$("#myModal-img").find(".text-warning").hide()}),e(i,t,n),!1});var s=Qiniu.detectIEVersion();if(!(s&&s<=9)){var o=Qiniu.exif(r.key);if(o){var u=$('<a href="" target="_blank">查看exif</a>');u.attr("href",i+"?exif"),t.append(u)}var a=Qiniu.imageInfo(r.key),f=$("<div/>"),l='<div>格式：<span class="origin-format">'+a.format+"</span></div>"+'<div>宽度：<span class="orgin-width">'+a.width+"px</span></div>"+'<div>高度：<span class="origin-height">'+a.height+"px</span></div>";f.html(l),t.append(f)}c.append(t)}).on("error",function(){d.attr("src","default.png"),c.addClass("default")})}},FileProgress.prototype.setError=function(){this.fileProgressWrapper.find("td:eq(2)").attr("class","text-warning"),this.fileProgressWrapper.find("td:eq(2) .progress").css("width",0).hide(),this.fileProgressWrapper.find("button").hide(),this.fileProgressWrapper.next(".chunk-status-tr").hide()},FileProgress.prototype.setCancelled=function(e){var t="progressContainer";e||(t+=" red"),this.fileProgressWrapper.attr("class",t),this.fileProgressWrapper.find("td .progress .progress-bar-info").css("width",0)},FileProgress.prototype.setStatus=function(e,t){t||this.fileProgressWrapper.find(".status").text(e).attr("class","status text-left")},FileProgress.prototype.appear=function(){this.getTimer()!==null&&(clearTimeout(this.getTimer()),this.setTimer(null));if(this.fileProgressWrapper[0].filters)try{this.fileProgressWrapper[0].filters.item("DXImageTransform.Microsoft.Alpha").opacity=100}catch(e){this.fileProgressWrapper.css("filter","progid:DXImageTransform.Microsoft.Alpha(opacity=100)")}else this.fileProgressWrapper.css("opacity",1);this.fileProgressWrapper.css("height",""),this.height=this.fileProgressWrapper.offset().top,this.opacity=100,this.fileProgressWrapper.show()};var UploadUtils=function(){var e=function(e){var n={token:"",domain:"",bucket:"",typebucket:"",iscover:!1,container:"upcontainer",browse_button:"uppickfiles",drop_element:"upcontainer",multi_selection:"",auto_start:!0,picname:"",fileNumLimit:10,imgw:750,imgh:1e3,startload:null,endload:null,callback:null,bcallback:null,previewback:null,upbtnback:null,selectFileAfer:null};e&&$.extend(!0,n,e);var r=[],i={runtimes:"html5,flash,html4",browse_button:n.browse_button,uptoken:n.token,unique_names:!1,domain:n.domain,multi_selection:n.multi_selection,bucket:n.bucket,container:n.container,resize:{width:n.imgw,height:n.imgh,quality:100},filters:[{title:"Image files",extensions:"jpg,gif,png,jpeg"}],max_file_size:"5mb",flash_swf_url:"js/comm/plupload/Moxie.swf",max_retries:1,dragdrop:!0,drop_element:n.container,chunk_size:"4mb",auto_start:n.auto_start,init:{FilesAdded:function(r,i){n.typebucket==2&&n.typebucket==2?($.each(r.files,function(e,t){if(r.files.length<=1)return;r.removeFile(t)}),e.previewback&&t(i[0],function(e){n.previewback(function(){o.start()},e)})):(plupload.each(i,function(r){n.auto_start==0&&n.typebucket==4&&t(r,function(t){$("#uploadTable").append("<li id='"+r.id+"tr'><img src='"+t+"' /><button type='button' id='"+r.id+"btn' class='del_file_btn btn btn-s' data-id='"+r.id+"'>删除</button><span id='"+r.id+"_progress'></span></li>"),$(".del_file_btn").unbind("click").bind("click",function(){var e=$(this).attr("data-id");l.removeFile(e),$("#"+e+"tr").remove()}),e.selectFileAfer&&n.selectFileAfer()});var i=new FileProgress(r,"fsUploadProgress");i.setStatus("等待...")}),n.auto_start==0&&e.upbtnback&&n.upbtnback(function(){l.start()})),n.multi_selection==1&&h.files.length>n.fileNumLimit&&h.splice(n.fileNumLimit,999)},BeforeUpload:function(t,r){var i=new FileProgress(r,"fsUploadProgress"),s=plupload.parseSize(this.getOption("chunk_size"));t.runtime==="html5"&&s&&i.setChunkProgess(s),n.tip||(e.startload?n.startload():AjaxFunUtils.ajaxInit({url:"/common/gettpl.html?name=progress&ch=sns",type:"GET",yzlogin:!0,isloading:!0,dataType:"html",params:"",callback:function(e){$("body").append(e),config.tip.centerDiv({divId:"dzuploadid",type:1})}}))},UploadProgress:function(e,t){var r=new FileProgress(t,"fsUploadProgress"),i=plupload.parseSize(this.getOption("chunk_size"));r.setProgress(t.percent+"%",e.total.bytesPerSec,i),n.tip?($("#progress").find(".text").html(t.percent+"%"),$("#progress").find(".percentage").css({width:t.percent+"%"}),$("#tipclose").hide()):($("#progress").find(".text").html(t.percent+"%"),$("#progress").find(".percentage").css({width:t.percent+"%"}))},FileUploaded:function(t,i,o){if(!n.tip)if(e.endload)n.endload();else{var u=$("#dzuploadid").attr("data-index");config.tip.centerDivClosed({indexTipDiv:$("#dzuploadid"),type:1,indexNum:u})}var a=$.parseJSON(o);if(n.typebucket==2)var l=s.imageInfo(a.key);else if(n.typebucket==3)var l={};else if(n.typebucket==4)var l=f.imageInfo(a.key);else var l=c.imageInfo(a.key);var h=l.width,p=l.height;if(l.orientation=="Right-top"||l.orientation=="Left-bottom")h=l.height,p=l.width;l.width=h,l.height=p;if(n.isarray){var d=h/236;a.key="/"+a.key,a.src=n.domain+"/"+a.key+"?imageMogr2/auto-orient",a.swidth=parseInt(h/d),a.sheight=parseInt(p/d),l.width=h,l.height=p;var v=$.extend(!0,a,l);r.push(v)}else{var v=$.extend(!0,a,l);r=v}e.bcallback&&n.bcallback(a,n.domain)},Error:function(t,r,i){e.errorcallback?n.errorcallback(t,r,i):config.tip.tips({htmlmsg:'<div style="padding:30px">'+i+"</div>",type:0,scallback:function(){var e=$("#dzuploadid").attr("data-index");config.tip.centerDivClosed({indexTipDiv:$("#dzuploadid"),type:1,indexNum:e})}})},UploadComplete:function(){e.callback&&n.callback(r,n.domain),n.tip&&closeUpload()},Key:function(e,t){var r=new Date,i=r.getFullYear(),s=r.getMonth()+1,o=r.getDate(),u=r.getHours(),a=r.getMinutes(),f=r.getSeconds();u<=9&&(u="0"+u),a<=9&&(a="0"+a),f<=9&&(f="0"+f),s<=9&&(s="0"+s),o<=9&&(o="0"+o);var l=i+""+s+""+o,c=String(Math.floor(Math.random()*1e8+1));c.length<4&&(c+="0000"),c=c.substr(0,4);var h=l+"/"+suid+"/"+u+""+a+""+f+""+c+".jpg";return n.iscover==1&&(h=n.picname),h}}};if(n.typebucket==2)var s=new QiniuJsSDK,o=s.uploader(i);else if(n.typebucket==3)var u=new QiniuJsSDK,a=u.uploader(i);else if(n.typebucket==4)var f=new QiniuJsSDK,l=f.uploader(i);else var c=new QiniuJsSDK,h=c.uploader(i)},t=function(e,t){if(!e||!/image\//.test(e.type))return;if(e.type=="image/gif"){var n=new mOxie.FileReader;n.onload=function(){t(n.result),n.destroy(),n=null},n.readAsDataURL(e.getSource())}else{var r=new mOxie.Image;r.onload=function(){var e=config.base.getHeightBody(),n=$("#footerbox").height(),i=$("#avatar_up_cmm").height(),s=$("#headerbox").height(),o=e-n-i-s,u=config.base.getWidthBody(),a=thisW=r.width,f=thisH=r.height,l=thisW/thisH;u>=750&&(u=750),l<=1?(thisH=o,thisW=thisH*l):(thisW=u,thisH=thisW/l),r.downsize(thisW,thisH);var c=r.type=="image/jpeg"?r.getAsDataURL("image/jpeg",80):r.getAsDataURL(),h={imgsrc:c,bili:l,w:thisW,h:thisH,dfw:a,dfh:f};t&&t(h),r.destroy(),r=null},r.load(e.getSource())}},n=function(t){function i(){AjaxFunUtils.ajaxInit({url:"/common/gettpl.html?name=uppic&ch=sns",type:"GET",yzlogin:!0,isloading:!0,dataType:"html",params:"",callback:function(e){$("body").append(e),$("#uppic_title").html(n.uptitle),config.tip.centerDiv({divId:"uploadid",type:1,callback:function(){s()},closeback:function(){}})}})}function s(){AjaxFunUtils.ajaxInit({url:"/qiniu/uptoken.html",params:{bucket:n.bucket,picname:n.picname},callback:function(r){r.status==1&&(t.startcallback&&n.startcallback(r),n.token=r.data.token,n.domain=r.data.domain,n.bucket=r.data.bucket,e(n))}})}var n={yzlogin:!0,bucket:"share",typebucket:"",container:"upcontainer",browse_button:"uppickfiles",drop_element:"upcontainer",multi_selection:!0,auto_start:!0,picname:"",tip:!1,isarray:!1,imgw:736,imgh:1e3,startcallback:function(){},callback:function(){},bcallback:function(){}};t&&$.extend(n,t);if(!n.yzlogin)return i(),!0;var r=BaseInitClass.loginCheck(1);if(!r)return $("#up_input").hide(),$("#upcontainer").unbind("click").bind("click",function(){BaseInitClass.loginCheck()}),!1;if(n.tip)return i(),!0;$("#up_input").show(),s()},r=function(e,t){var n={share:"up",isOri:"true",boradid:"",fileNumLimit:10,ismjx:0};t&&$.extend(!0,n,t),ShareUtils.addShareInit(e,{share:n.share,isOri:n.isOri,boradid:n.boradid,ismjx:n.ismjx})};return{uploadInit:n,successFun:r,uploaderQiNiu:e}}();