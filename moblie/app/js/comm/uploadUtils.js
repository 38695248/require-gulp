define(["jquery","config","ajax","comm/shareUtils","qiniu/ui","qiniu/plupload.full.min","qiniu/qiniu"],function(e,t,n,r){var i=function(r){var i={token:"",domain:"",bucket:"",typebucket:"",iscover:!1,container:"upcontainer",browse_button:"uppickfiles",drop_element:"upcontainer",multi_selection:"",auto_start:!0,picname:"",fileNumLimit:10,imgw:750,imgh:1e3,startload:null,endload:null,callback:null,bcallback:null,previewback:null,upbtnback:null,selectFileAfer:null};r&&e.extend(!0,i,r);var o=[],u={runtimes:"html5,flash,html4",browse_button:i.browse_button,uptoken:i.token,unique_names:!1,domain:i.domain,multi_selection:i.multi_selection,bucket:i.bucket,container:i.container,resize:{width:i.imgw,height:i.imgh,quality:100},filters:[{title:"Image files",extensions:"jpg,gif,png,jpeg"}],max_file_size:"5mb",flash_swf_url:"plupload/Moxie.swf",max_retries:1,dragdrop:!0,drop_element:i.container,chunk_size:"4mb",auto_start:i.auto_start,init:{FilesAdded:function(t,n){i.typebucket==2&&i.typebucket==2?(e.each(t.files,function(e,n){if(t.files.length<=1)return;t.removeFile(n)}),r.previewback&&s(n[0],function(e){i.previewback(function(){f.start()},e)})):(plupload.each(n,function(t){i.auto_start==0&&i.typebucket==4&&s(t,function(n){e("#uploadTable").append("<li id='"+t.id+"tr'><img src='"+n+"' /><button type='button' id='"+t.id+"btn' class='del_file_btn btn btn-s' data-id='"+t.id+"'>删除</button><span id='"+t.id+"_progress'></span></li>"),e(".del_file_btn").unbind("click").bind("click",function(){var t=e(this).attr("data-id");p.removeFile(t),e("#"+t+"tr").remove()}),r.selectFileAfer&&i.selectFileAfer()});var n=new FileProgress(t,"fsUploadProgress");n.setStatus("等待...")}),i.auto_start==0&&r.upbtnback&&i.upbtnback(function(){p.start()})),i.multi_selection==1&&v.files.length>i.fileNumLimit&&v.splice(i.fileNumLimit,999)},BeforeUpload:function(s,o){var u=new FileProgress(o,"fsUploadProgress"),a=plupload.parseSize(this.getOption("chunk_size"));s.runtime==="html5"&&a&&u.setChunkProgess(a),i.tip||(r.startload?i.startload():n.ajaxInit({url:"/common/gettpl.html?name=progress&ch=sns",type:"GET",yzlogin:!0,isloading:!0,dataType:"html",params:"",callback:function(n){e("body").append(n),t.tip.centerDiv({divId:"dzuploadid",type:1})}}))},UploadProgress:function(t,n){var r=new FileProgress(n,"fsUploadProgress"),s=plupload.parseSize(this.getOption("chunk_size"));r.setProgress(n.percent+"%",t.total.bytesPerSec,s),i.tip?(e("#progress").find(".text").html(n.percent+"%"),e("#progress").find(".percentage").css({width:n.percent+"%"}),e("#tipclose").hide()):(e("#progress").find(".text").html(n.percent+"%"),e("#progress").find(".percentage").css({width:n.percent+"%"}))},FileUploaded:function(n,s,u){if(!i.tip)if(r.endload)i.endload();else{var f=e("#dzuploadid").attr("data-index");t.tip.centerDivClosed({indexTipDiv:e("#dzuploadid"),type:1,indexNum:f})}var l=e.parseJSON(u);if(i.typebucket==2)var c=a.imageInfo(l.key);else if(i.typebucket==3)var c={};else if(i.typebucket==4)var c=h.imageInfo(l.key);else var c=d.imageInfo(l.key);var p=c.width,v=c.height;if(c.orientation=="Right-top"||c.orientation=="Left-bottom")p=c.height,v=c.width;c.width=p,c.height=v;if(i.isarray){var m=p/236;l.key="/"+l.key,l.src=i.domain+"/"+l.key+"?imageMogr2/auto-orient",l.swidth=parseInt(p/m),l.sheight=parseInt(v/m),c.width=p,c.height=v;var g=e.extend(!0,l,c);o.push(g)}else{var g=e.extend(!0,l,c);o=g}r.bcallback&&i.bcallback(l,i.domain)},Error:function(n,s,o){r.errorcallback?i.errorcallback(n,s,o):t.tip.tips({htmlmsg:'<div style="padding:30px">'+o+"</div>",type:0,scallback:function(){var n=e("#dzuploadid").attr("data-index");t.tip.centerDivClosed({indexTipDiv:e("#dzuploadid"),type:1,indexNum:n})}})},UploadComplete:function(){r.callback&&i.callback(o,i.domain),i.tip&&t.closeTip(e("#uploadid"))},Key:function(e,t){var n=new Date,r=n.getFullYear(),s=n.getMonth()+1,o=n.getDate(),u=n.getHours(),a=n.getMinutes(),f=n.getSeconds();u<=9&&(u="0"+u),a<=9&&(a="0"+a),f<=9&&(f="0"+f),s<=9&&(s="0"+s),o<=9&&(o="0"+o);var l=r+""+s+""+o,c=String(Math.floor(Math.random()*1e8+1));c.length<4&&(c+="0000"),c=c.substr(0,4);var h=l+"/"+suid+"/"+u+""+a+""+f+""+c+".jpg";return i.iscover==1&&(h=i.picname),h}}};if(i.typebucket==2)var a=new QiniuJsSDK,f=a.uploader(u);else if(i.typebucket==3)var l=new QiniuJsSDK,c=l.uploader(u);else if(i.typebucket==4)var h=new QiniuJsSDK,p=h.uploader(u);else var d=new QiniuJsSDK,v=d.uploader(u)},s=function(n,r){if(!n||!/image\//.test(n.type))return;if(n.type=="image/gif"){var i=new mOxie.FileReader;i.onload=function(){r(i.result),i.destroy(),i=null},i.readAsDataURL(n.getSource())}else{var s=new mOxie.Image;s.onload=function(){var n=t.base.getHeightBody(),i=e("#footerbox").height(),o=e("#avatar_up_cmm").height(),u=e("#headerbox").height(),a=n-i-o-u,f=t.base.getWidthBody(),l=thisW=s.width,c=thisH=s.height,h=thisW/thisH;f>=750&&(f=750),h<=1?(thisH=a,thisW=thisH*h):(thisW=f,thisH=thisW/h),s.downsize(thisW,thisH);var p=s.type=="image/jpeg"?s.getAsDataURL("image/jpeg",80):s.getAsDataURL(),d={imgsrc:p,bili:h,w:thisW,h:thisH,dfw:l,dfh:c};r&&r(d),s.destroy(),s=null},s.load(n.getSource())}},o=function(r){function u(){n.ajaxInit({url:"/common/gettpl.html?name=uppic&ch=sns",type:"GET",yzlogin:!0,isloading:!0,dataType:"html",params:"",callback:function(n){e("body").append(n),e("#uppic_title").html(s.uptitle),t.tip.centerDiv({divId:"uploadid",type:1,callback:function(){a()},closeback:function(){}})}})}function a(){n.ajaxInit({url:"/qiniu/uptoken.html",params:{bucket:s.bucket,picname:s.picname},callback:function(e){e.status==1&&(r.startcallback&&s.startcallback(e),s.token=e.data.token,s.domain=e.data.domain,s.bucket=e.data.bucket,i(s))}})}var s={yzlogin:!0,bucket:"share",typebucket:"",container:"upcontainer",browse_button:"uppickfiles",drop_element:"upcontainer",multi_selection:!0,auto_start:!0,picname:"",tip:!1,isarray:!1,imgw:736,imgh:1e3,startcallback:function(){},callback:function(){},bcallback:function(){}};r&&e.extend(s,r);if(!s.yzlogin)return u(),!0;var o=t.loginCheck(1);if(!o)return e("#up_input").hide(),e("#upcontainer").unbind("click").bind("click",function(){t.loginCheck()}),!1;if(s.tip)return u(),!0;e("#up_input").show(),a()},u=function(n,i){var s={share:"up",isOri:"true",boradid:"",fileNumLimit:10,ismjx:0};i&&e.extend(!0,s,i),t.closeTip(e("#uploadid")),r.addShareInit(n,{share:s.share,isOri:s.isOri,boradid:s.boradid,ismjx:s.ismjx})};return{uploadInit:o,successFun:u}});