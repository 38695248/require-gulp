(function(e){typeof define=="function"&&define.amd?define(["jquery"],e):e(jQuery)})(function(e,t){"use strict";e.infinitescroll=function(n,r,i){this.element=e(i),this._create(n,r)||(this.failed=!0)},e.infinitescroll.defaults={loading:{finished:t,finishedMsg:"<em>Congratulations, you've reached the end of the internet.</em>",img:"",msg:null,msgText:"<em>Loading the next set of posts...</em>",selector:null,speed:"fast",start:t},state:{isDuringAjax:!1,isInvalidPage:!1,isDestroyed:!1,isDone:!1,isPaused:!1,isBeyondMaxPage:!1,currPage:1},debug:!1,behavior:t,binder:e(window),nextSelector:"div.navigation a:first",navSelector:"div.navigation",contentSelector:null,extraScrollPx:150,itemSelector:"div.post",animate:!1,pathParse:t,dataType:"html",appendCallback:!1,bufferPx:40,errorCallback:function(){},infid:0,pixelsFromNavToBottom:t,path:t,prefill:!1,maxPage:t},e.infinitescroll.prototype={_binding:function(n){var r=this,i=r.options;i.v="2.0b2.120520";if(!!i.behavior&&this["_binding_"+i.behavior]!==t){this["_binding_"+i.behavior].call(this);return}if(n!=="bind"&&n!=="unbind")return this._debug("Binding value  "+n+" not valid"),!1;n==="unbind"?this.options.binder.unbind("smartscroll.infscr."+r.options.infid):this.options.binder[n]("smartscroll.infscr."+r.options.infid,function(){r.scroll()}),this._debug("Binding",n)},_create:function(r,i){var s=e.extend(!0,{},e.infinitescroll.defaults,r);this.options=s;var o=e(window),u=this;if(!u._validate(r))return!1;var a=e(s.nextSelector).attr("href"),f=e(this.element).find(".item").eq(0).attr("data-page");f&&(a=f);if(!a)return this._debug("Navigation selector not found"),!1;s.path=s.path||this._determinepath(a),s.contentSelector=s.contentSelector||this.element,s.loading.selector=s.loading.selector||s.contentSelector,s.loading.msg=s.loading.msg||e('<div id="data-loading" class="rel data-loading" style="display:none"><div class="infscr-loading" id="infscr-loading" style="text-align:center"><img alt="Loading..." src="'+s.loadingImg+'" /></div></div>"'),(new Image).src=s.loading.img,s.pixelsFromNavToBottom===t&&(s.pixelsFromNavToBottom=e(document).height()-e(s.navSelector).offset().top,console.log(s.pixelsFromNavToBottom),this._debug("pixelsFromNavToBottom: "+s.pixelsFromNavToBottom));var l=this;return s.loading.start=s.loading.start||function(){e(s.navSelector).hide(),s.loading.selector.after(s.loading.msg),s.loading.msg.show(s.loading.speed,e.proxy(function(){this.beginAjax(s)},l))},s.loading.finished=s.loading.finished||function(){s.state.isBeyondMaxPage||s.loading.msg.fadeOut(s.loading.speed)},s.callback=function(n,r,u){!!s.behavior&&n["_callback_"+s.behavior]!==t&&n["_callback_"+s.behavior].call(e(s.contentSelector)[0],r,u),i&&i.call(e(s.contentSelector)[0],r,s,u),s.prefill&&o.bind("resize.infinite-scroll",n._prefill)},r.debug&&Function.prototype.bind&&(typeof console=="object"||typeof console=="function")&&typeof console.log=="object"&&["log","info","warn","error","assert","dir","clear","profile","profileEnd"].forEach(function(e){console[e]=this.call(console[e],console)},Function.prototype.bind),this._setup(),s.prefill&&this._prefill(),!0},_prefill:function(){function i(){return e(n.options.contentSelector).height()<=r.height()}var n=this,r=e(window);this._prefill=function(){i()&&n.scroll(),r.bind("resize.infinite-scroll",function(){i()&&(r.unbind("resize.infinite-scroll"),n.scroll())})},this._prefill()},_debug:function(){if(!0!==this.options.debug)return;typeof console!="undefined"&&typeof console.log=="function"?Array.prototype.slice.call(arguments).length===1&&typeof Array.prototype.slice.call(arguments)[0]=="string"?console.log(Array.prototype.slice.call(arguments).toString()):console.log(Array.prototype.slice.call(arguments)):!Function.prototype.bind&&typeof console!="undefined"&&typeof console.log=="object"&&Function.prototype.call.call(console.log,console,Array.prototype.slice.call(arguments))},_determinepath:function(r){var i=this.options;if(!i.behavior||this["_determinepath_"+i.behavior]===t)return r.match(/^(.*?page=)\d(.*)/)?(r=r.match(/^(.*?page=)\d(.*)/).slice(1),r):e.isFunction(i.pathParse)?[r]:(props.isInvalidPage=!0,this._debug("determinePath",r),r);return this["_determinepath_"+i.behavior].call(this,r)},_error:function(n){var r=this.options;if(!!r.behavior&&this["_error_"+r.behavior]!==t){this["_error_"+r.behavior].call(this,n);return}n!=="destroy"&&n!=="end"&&(n="unknown"),this._debug("Error",n),(n==="end"||r.state.isBeyondMaxPage)&&this._showdonemsg(),r.state.isDone=!0,r.state.currPage=1,r.state.isPaused=!1,r.state.isBeyondMaxPage=!1,this._binding("unbind")},_loadcallback:function(r,i,s){var o=this.options,u=this.options.callback,a=o.state.isDone?"done":o.appendCallback?"append":"no-append",f;if(!!o.behavior&&this["_loadcallback_"+o.behavior]!==t){this["_loadcallback_"+o.behavior].call(this,r,i,s);return}switch(a){case"done":return this._showdonemsg(),!1;case"no-append":o.dataType==="html"&&(i="<div>"+i+"</div>",i=e(i).find(o.itemSelector));if(i.length===0)return this._error("end");break;case"append":var l=r.children();if(l.length===0)return this._error("end");f=document.createDocumentFragment();while(r[0].firstChild)f.appendChild(r[0].firstChild);this._debug("contentSelector",e(o.contentSelector)[0]),e(o.contentSelector)[0].appendChild(f),i=l.get();var c=e(e(i).find(".item").prevObject[0]).attr("data-page");if(o.searchflag||c)o.desturl=c}o.loading.finished.call(e(o.contentSelector)[0],o);if(o.animate){var h=e(window).scrollTop()+e(o.loading.msg).height()+o.extraScrollPx+"px";e("html,body").animate({scrollTop:h},800,function(){o.state.isDuringAjax=!1})}o.animate||(o.state.isDuringAjax=!1),u(this,i,s),o.prefill&&this._prefill()},_nearbottom:function(){var r=this.options,i=0+e(document).height()-r.binder.scrollTop()-e(window).height();return!r.behavior||this["_nearbottom_"+r.behavior]===t?(this._debug("math:",i,r.pixelsFromNavToBottom),i/2-r.bufferPx<r.pixelsFromNavToBottom):this["_nearbottom_"+r.behavior].call(this)},_pausing:function(n){var r=this.options;if(!r.behavior||this["_pausing_"+r.behavior]===t){n!=="pause"&&n!=="resume"&&n!==null&&this._debug("Invalid argument. Toggling pause value instead"),n=!n||n!=="pause"&&n!=="resume"?"toggle":n;switch(n){case"pause":r.state.isPaused=!0;break;case"resume":r.state.isPaused=!1;break;case"toggle":r.state.isPaused=!r.state.isPaused}return this._debug("Paused",r.state.isPaused),!1}this["_pausing_"+r.behavior].call(this,n);return},_setup:function(){var n=this.options;if(!n.behavior||this["_setup_"+n.behavior]===t)return this._binding("bind"),!1;this["_setup_"+n.behavior].call(this);return},_showdonemsg:function(){var r=this.options;if(!!r.behavior&&this["_showdonemsg_"+r.behavior]!==t){this["_showdonemsg_"+r.behavior].call(this);return}r.loading.msg.find("img").hide().parent().find("div").html(r.loading.finishedMsg).animate({opacity:1},2e3,function(){e(this).parent().fadeOut(r.loading.speed)}),r.errorCallback.call(e(r.contentSelector)[0],"done")},_validate:function(n){for(var r in n)if(r.indexOf&&r.indexOf("Selector")>-1&&e(n[r]).length===0)return this._debug("Your "+r+" found no elements."),!1;return!0},bind:function(){this._binding("bind")},destroy:function(){return this.options.state.isDestroyed=!0,this.options.loading.finished(),this._error("destroy")},pause:function(){this._pausing("pause")},resume:function(){this._pausing("resume")},beginAjax:function(r){var i=this,s=r.path,o,u,a,f;r.state.currPage++;if(r.maxPage!==t&&r.state.currPage>r.maxPage){r.state.isBeyondMaxPage=!0,this.destroy();return}o=e(r.contentSelector).is("table, tbody")?e("<tbody/>"):e("<div/>"),r.searchflag&&r.desturl?u=r.desturl:u=typeof s=="function"?s(r.state.currPage):s.join(r.state.currPage),i._debug("heading into ajax",u),a=r.dataType==="html"||r.dataType==="json"?r.dataType:"html+callback",r.appendCallback&&r.dataType==="html"&&(a+="+callback");switch(a){case"html+callback":i._debug("Using HTML via .load() method"),o.load(u+" "+r.itemSelector,t,function(t){i._loadcallback(o,t,u)});break;case"html":i._debug("Using "+a.toUpperCase()+" via $.ajax() method"),e.ajax({url:u,dataType:r.dataType,complete:function(t,n){f=typeof t.isResolved!="undefined"?t.isResolved():n==="success"||n==="notmodified",f?i._loadcallback(o,t.responseText,u):i._error("end")}});break;case"json":i._debug("Using "+a.toUpperCase()+" via $.ajax() method"),e.ajax({dataType:"json",type:"GET",url:u,success:function(e,n,s){f=typeof s.isResolved!="undefined"?s.isResolved():n==="success"||n==="notmodified";if(r.appendCallback)if(r.template!==t){var a=r.template(e);o.append(a),f?i._loadcallback(o,a):i._error("end")}else i._debug("template must be defined."),i._error("end");else e.status?i._loadcallback(o,e,u):i._error("end")},error:function(){i._debug("JSON ajax request failed."),i._error("end")}})}},retrieve:function(r){r=r||null;var i=this,s=i.options;if(!!s.behavior&&this["retrieve_"+s.behavior]!==t){this["retrieve_"+s.behavior].call(this,r);return}if(s.state.isDestroyed)return this._debug("Instance is destroyed"),!1;s.state.isDuringAjax=!0,s.loading.start.call(e(s.contentSelector)[0],s)},scroll:function(){var n=this.options,r=n.state;if(!!n.behavior&&this["scroll_"+n.behavior]!==t){this["scroll_"+n.behavior].call(this);return}if(r.isDuringAjax||r.isInvalidPage||r.isDone||r.isDestroyed||r.isPaused)return;if(!this._nearbottom())return;this.retrieve()},toggle:function(){this._pausing()},unbind:function(){this._binding("unbind")},update:function(n){e.isPlainObject(n)&&(this.options=e.extend(!0,this.options,n))}},e.fn.infinitescroll=function(n,r){var i=typeof n;switch(i){case"string":var s=Array.prototype.slice.call(arguments,1);this.each(function(){var t=e.data(this,"infinitescroll");if(!t)return!1;if(!e.isFunction(t[n])||n.charAt(0)==="_")return!1;t[n].apply(t,s)});break;case"object":this.each(function(){var t=e.data(this,"infinitescroll");t?t=new e.infinitescroll(n,r,this):(t=new e.infinitescroll(n,r,this),t.failed||e.data(this,"infinitescroll",t))})}return this};var n=e.event,r;n.special.smartscroll={setup:function(){e(this).bind("scroll",n.special.smartscroll.handler)},teardown:function(){e(this).unbind("scroll",n.special.smartscroll.handler)},handler:function(t,n){var i=this,s=arguments;t.type="smartscroll",r&&clearTimeout(r),r=setTimeout(function(){e(i).trigger("smartscroll",s)},n==="execAsap"?0:100)}},e.fn.smartscroll=function(e){return e?this.bind("smartscroll",e):this.trigger("smartscroll",["execAsap"])}});